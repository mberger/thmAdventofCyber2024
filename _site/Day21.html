<!doctype html>
<html>
  <head>
  <title>
    
      TryHackMe ADvent of Cyber 2024 - Day 21 | THM Advent of Cyber 2024
    
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8">
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/syntax.css">
  <!-- Use Atom -->
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="THM Advent of Cyber 2024" />
  <!-- RSS-v2.0
  <link href="/rss-feed.xml" type="application/rss+xml" rel="alternate" title="THM Advent of Cyber 2024 | a minimalist Jekyll theme for running a blog or publication"/>
  //-->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Source+Code+Pro">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>
  <!-- Google Analytics -->
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'G-MSZW3HWGH8', 'auto');
  ga('send', 'pageview');
</script>

  <!-- Use Jekyll SEO plugin -->
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>TryHackMe ADvent of Cyber 2024 - Day 21 | THM Advent of Cyber 2024</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="TryHackMe ADvent of Cyber 2024 - Day 21" />
<meta name="author" content="Michael" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The Story" />
<meta property="og:description" content="The Story" />
<link rel="canonical" href="http://localhost:4000/Day21" />
<meta property="og:url" content="http://localhost:4000/Day21" />
<meta property="og:site_name" content="THM Advent of Cyber 2024" />
<meta property="og:image" content="http://localhost:4000/Day21Header.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-12-21T00:00:00-05:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/Day21Header.png" />
<meta property="twitter:title" content="TryHackMe ADvent of Cyber 2024 - Day 21" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Michael"},"dateModified":"2024-12-21T00:00:00-05:00","datePublished":"2024-12-21T00:00:00-05:00","description":"The Story","headline":"TryHackMe ADvent of Cyber 2024 - Day 21","image":"http://localhost:4000/Day21Header.png","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/Day21"},"url":"http://localhost:4000/Day21"}</script>
<!-- End Jekyll SEO tag -->

</head>

  <body>
    <div class="container">
      <header class="site-header">
  <h3 class="site-title">
    <a href="/">THM Advent of Cyber 2024</a>
  </h3>
  <nav class="menu-list">
    
      <a href="/about" class="menu-link">About</a>
    
      <a href="/contact" class="menu-link">Contact</a>
    
    
      <a href="https://twitter.com/mberger" class="menu-link" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
    
      <a href="feed.xml" class="menu-link" target="_blank"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
    
  </nav>
  <div class="dropdown">
    <button class="dropbtn"><i class="fa fa-bars" aria-hidden="true"></i></button>
    <div class="dropdown-content">
      
        <a href="/about" class="menu-link">About</a>
      
        <a href="/contact" class="menu-link">Contact</a>
      
      
        <a href="https://twitter.com/mberger" class="menu-link" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
      
        <a href="feed.xml" class="menu-link" target="_blank"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
      
    </div>
  </div>
</header>

      <div class="content-wrapper">
        <div class="post-content">
  <h1>
    TryHackMe ADvent of Cyber 2024 - Day 21
  </h1>
  
    <span class="post-date">
  Written on
  
  December
  21st
    ,
  2024
  by
  
    Michael
  
</span>

  
  
    <div class="featured-image">
      <img src="/assets/img/Day21Header.png">
    </div>
  
  <article>
    <p>The Story</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/62a7685ca6e7ce005d3f3afe-1732165566749.png" alt="Task banner for day 21" /></p>

<p>\n</p>

<p><em>McSkidy’s alert dashboard lit up with an unusual alert. A file-sharing web application built by Glitch had triggered a security warning. Glitch had been working hard during this season’s SOC-mas after the last scare with the Yule Log Exploit, but this new alert caused McSkidy to question his intentions.</em></p>

<p><em>McSkidy began to investigate. It seemed the source of the alert came from a binary file that made its way to the web app’s backend. It did not belong there and had some anomalous activity. The binary was compiled with .NET. This whole setup seemed quite unusual, and with Glitch working on the latest security updates, McSkidy was filled with suspicion.</em></p>

<p><em>As McSkidy continued her investigation, Glitch rushed into the room: “I swear I did not put it there! I was testing defences, but I wouldn’t go that far!</em></p>

<p><em>McSkidy reassured him, “This doesn’t look like your work. Let’s get to the bottom of this. Put on your decompiling hat, and let’s see what we are dealing with.”</em></p>

<h2 id="learning-objectives">Learning Objectives</h2>

<ul>
  <li>Understanding the structure of a binary file </li>
  <li>The difference between Disassembly vs Decompiling</li>
  <li>Familiarity with multi-stage binaries</li>
  <li>Practically reversing a  multi-stage binary</li>
</ul>

<h2 id="connecting-to-the-machine">Connecting to the Machine</h2>

<p>Before moving forward, review the questions in the connection card shown below:</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/63588b5ef586912c7d03c4f0/room-content/63588b5ef586912c7d03c4f0-1731050107820.png" alt="Task connection card." /></p>

<p>Click on the green <code class="language-plaintext highlighter-rouge">Start Machine</code> button below to start the virtual machine in split-screen view. If the VM is not visible, use the blue <code class="language-plaintext highlighter-rouge">Show Split View</code> button at the top of the page. Alternatively, you can connect to the VM via Remote Desktop (RDP) using the credentials below:</p>

<p>Start Machine</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/63588b5ef586912c7d03c4f0/room-content/be629720b11a294819516c1d4e738c92.png" alt="THM key" /></p>

<table>
  <thead>
    <tr>
      <th><strong>Username</strong></th>
      <th>Administrator</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Password</strong></td>
      <td>AOCRE123!</td>
    </tr>
    <tr>
      <td><strong>IP</strong></td>
      <td>10.10.135.151</td>
    </tr>
  </tbody>
</table>

<h2 id="introduction-to-reverse-engineering">Introduction to Reverse Engineering</h2>

<p>Reverse Engineering (RE) is the process of breaking something down to understand its function. In cyber security, reverse engineering is used to analyse how applications (binaries) function. This can be used to determine whether or not the application is malicious or if there are any security bugs present.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5de96d9ca744773ea7ef8c00/room-content/5de96d9ca744773ea7ef8c00-1729850809897.png" alt="WannaCry popup asking for payment" /> \n</p>

<p>For example, cyber security analysts reverse engineer malicious applications distributed by attackers to understand if there are any attributable indicators to associate the binary with an attacker and any potential ways to defend against the malicious binary. A famous example of this is the <a href="https://en.wikipedia.org/wiki/WannaCry_ransomware_attack">WannaCry</a> ransomware in May 2017. Security researcher <a href="https://en.wikipedia.org/wiki/Marcus_Hutchins">Marcus Hutchins</a> reverse-engineered the ransomware application and discovered a specific function within the application where the malware wouldn’t run if a particular domain were registered and available.</p>

<p>Marcus then registered this domain, stopping the global WannaCry attack. This is just one of many famous cases of reverse engineering being used in cyber security defence.</p>

<h2 id="binaries">Binaries</h2>

<p>﻿In computing, binaries are files compiled from source code. For example, you run a binary when launching an executable file on your computer. At one point in time, this application would’ve been programmed in a programming language such as C#. It is then compiled, and the compiler translates the code into machine instructions.</p>

<p>Binaries have a specific structure depending on the operating system they are designed to run. For example, Windows binaries follow the Portable Executable (PE) structure, whereas on Linux, binaries follow the Executable and Linkable Format (ELF). This is why, for example, you cannot run a <strong>.exe</strong> file on MacOS. With that said, all binaries will contain at least:</p>

<ul>
  <li><strong>A code section:</strong> This section contains the instructions that the CPU will execute</li>
  <li><strong>A data section:</strong> This section contains information such as variables, resources (images, other data), etc</li>
  <li><strong>Import/Export tables:</strong> These tables reference additional libraries used (imported) or exported by the binary. Binaries often rely on libraries to perform functions. For example, interacting with the Windows API to manipulate files</li>
</ul>

<p>The binaries in today’s task follow the PE structure. This structure will be explained throughout the task.</p>

<h2 id="disassembly-vs-decompiling">Disassembly Vs. Decompiling</h2>

<p>When reverse engineering binaries, you will employ two primary techniques. This task section will introduce you to disassembly and decompiling, explaining the key differences and their pros and cons.</p>

<p>Disassembling a binary shows the low-level machine instructions the binary will perform (you may know this as assembly). Because the output is translated machine instructions, you can see a detailed view of how the binary will interact with the system at what stage. Tools such as IDA, Ghidra, and GDB can do this.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5de96d9ca744773ea7ef8c00/room-content/5de96d9ca744773ea7ef8c00-1729849249700.png" alt="disassembling a binary" /> \n</p>

<p>Decompiling, however, converts the binary into its high-level code, such as C++, C#, etc., making it easier to read. However, this translation can often lose information such as variable names. This method of reverse engineering a binary is useful if you want to get a high-level understanding of the application’s flow.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5de96d9ca744773ea7ef8c00/room-content/5de96d9ca744773ea7ef8c00-1729849283353.png" alt="Decompiling using ILSpy" /> \n</p>

<p>There are specific circumstances where you would choose one method over the other. For example, decompiling is sometimes a “best guess” based on the tooling you’ve used and does not provide the actual full source code.</p>

<p>A table outlining the key differences between the two has been provided below.</p>

<table>
  <thead>
    <tr>
      <th><strong>Comparison</strong></th>
      <th><strong>Disassembly</strong></th>
      <th><strong>Decompiling</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Readability</strong></td>
      <td>Requires knowing assembly and low-level knowledge of computing concepts.</td>
      <td>Requires familiarity with programming and logic</td>
    </tr>
    <tr>
      <td><strong>Level of output</strong></td>
      <td>The translated output is the exact instructions that the machine will perform.</td>
      <td>The translated output is often a “best guess”. The output may not be accurate, and useful information, such as variables, function names, etc, will likely be lost.</td>
    </tr>
    <tr>
      <td><strong>Difficulty</strong></td>
      <td>The difficulty can be considered higher as the machine instructions are translated into assembly.</td>
      <td>The machine instructions are translated into a high-level language, which makes them easier to understand if you are familiar with the language the binary is written in.</td>
    </tr>
    <tr>
      <td><strong>Usefulness</strong></td>
      <td>The entire behaviour of the binary can be studied given enough time.</td>
      <td>Decompiling is a quick way to understand some of the logic of the binary.</td>
    </tr>
  </tbody>
</table>

<h2 id="multi-stage-binaries">Multi-Stage Binaries</h2>

<p>Recent trends in cyber security have seen the rise of attackers using what’s known as “Multi-stage binaries” in their campaigns - especially malware. These attacks involve using multiple binaries responsible for different actions rather than one performing the entire attack. Usually, an attack involving various binaries will look like the following:</p>

<ol>
  <li><strong>Stage 1 - Dropper:</strong> This binary is usually a lightweight, basic binary responsible for actions such as enumerating the operating system to see if the payload will work. Once certain conditions are verified, the binary will download the second - much more malicious - binary from the attacker’s infrastructure.</li>
  <li><strong>Stage 2 - Payload:</strong> This binary is the “meat and bones” of the attack. For example, in the event of ransomware, this payload will encrypt and exfiltrate the data.</li>
</ol>

<p>Sophisticated attackers may further split actions of the attack chain (e.g., lateral movement) into additional binaries. Using multiple stages helps evade detection and makes the analysis process more difficult.</p>

<p>For example, a small, more “harmless” initial binary is likelier to evade detection via email filtering than a fully-fledged binary that performs malicious actions such as encryption. Additionally, splitting these functions into multiple stages gives the attacker much more control (i.e. only downloading specific stages once conditions such as time have been met).</p>

<p>The diagram below shows what an attack involving multiple staged binaries may look like.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/62a7685ca6e7ce005d3f3afe-1732167874084.png" alt="Depicting the stages of a multi-stage binary. At first there is an entry point such as from a phishing email, then an initial dropper which executes a downloader containing the malware" /></p>

<h2 id="jingle-net-all-the-way">Jingle .NET all the way</h2>

<p>For today’s task, you will be reverse engineering two .NET binaries using the decompiler ILSpy. You can follow the walkthrough below in reverse engineering using an example application named <code class="language-plaintext highlighter-rouge">demo.exe</code>. Then, you will reverse an application on your own at the end of this task.</p>

<p>Before analysing our target, we need to learn and find a way to identify the original binary file, modify it, or use it as evidence. Also, it is good practice to have a big picture of the file we are dealing with so that we can choose the proper tools we will need.</p>

<p>Let’s start by navigating to the file location in the <strong>demo</strong> folder on the machine’s Desktop by right-clicking on the file named <strong>demo</strong> and clicking on <code class="language-plaintext highlighter-rouge">Properties</code>.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/66264cef7bba67a6bbbe7179/room-content/66264cef7bba67a6bbbe7179-1729800848396.png" alt="clicking on properties option" /></p>

<p>\n</p>

<p>We can observe that the file’s extension is .exe, indicating that it is a Windows executable.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/66264cef7bba67a6bbbe7179/room-content/66264cef7bba67a6bbbe7179-1729642810578.png" alt="checking properties of demo.exe" /> \n</p>

<p>Since it’s a Windows file, we’ll use <a href="https://www.winitor.com/download">PEStudio</a>, a software designed to investigate potentially malicious files and extract information from them without execution. This will help us focus on the static analysis side of the investigation. Let’s open PEstudio from the taskbar and then click on  <strong>File</strong> &gt; <strong>Open</strong> and select the file <code class="language-plaintext highlighter-rouge">demo.exe</code> located in <code class="language-plaintext highlighter-rouge">C:\Users\Administrator\Desktop\demo\demo.exe</code> as shown below.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/62a7685ca6e7ce005d3f3afe-1732169586145.png" alt="opening file in PEStuido" /> \n</p>

<p>As shown below, PEStudio will display information about the file, so let’s start enumerating some of the most important aspects we can get from it. Using the left panel, we can navigate through different sections that will share different types of information about the file. In the general information output displayed when opening the file, we can see the hash of the file in the form of <strong>SHA-256</strong>, The architecture type, in this case, <strong>x64</strong>, the file type, and the signature of the language used to compile the executable, in this case, .<strong>NET framework</strong> that uses the C# language.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/62a7685ca6e7ce005d3f3afe-1732169775728.png" alt="analysing headers in PEStudio" /> \n</p>

<p>Let’s focus on some critical data we can obtain. First, if we want to identify the file and provide evidence of its alteration, we need to take note of the file’s SHA-256 hash, as we mentioned above, as well as the hash of each section on the PE file. PE stands for Portable Executable, and it’s the format in which Windows executables are arranged; you can learn more about it <a href="https://learn.microsoft.com/en-us/windows/win32/debug/pe-format">here</a>. </p>

<p><a href="https://learn.microsoft.com/en-us/windows/win32/debug/pe-format#section-table-section-headers">The sections</a> represent a memory space with different content of the Windows executable within the PE format. We can calculate the hash of these sections in order to identify the executable properly. We’ll focus this time on two hashes: the one from the <a href="https://learn.microsoft.com/en-us/windows/win32/debug/pe-format#:\~:text=in%20that%20module.-,.text,Executable%20code%20(free%20format),-IMAGE_SCN_CNT_CODE%20%7C%20IMAGE_SCN_MEM_EXECUTE%20%7C%20IIMAGE_SCN_MEM_READ">.text</a> section, which is the section on the file containing the executable code; this section is often marked as Read and executable, so it should not have any alterations when the file is being copied. We can observe them in the screenshot below:</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/62a7685ca6e7ce005d3f3afe-1732169883274.png" alt="checking sections in PEStudio" /> \n</p>

<p>Another essential section we can use to obtain information about the binary is the “indicators” section. This section tells us about the potential indicators like URLs or other suspicious attributes of a binary.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/62a7685ca6e7ce005d3f3afe-1732170189213.png" alt="Checking Strings in PEStudio" /></p>

<p>The screenshot above shows several strings on the file, like file names, URLs, and function names. This can be very important depending on the file’s execution flow. Additionally, looking for artefacts such as IP addresses, URLs, and crypto wallets can be a “quick win” for gathering some identifying intelligence. We’ll learn about that in the next section.</p>

<p>Now that we have information about the file we are investigating, let’s try to understand what the executable is doing. We need to understand its flow. If we try to read the file by opening it, we cannot do it since it’s in binary format. In the previous section, we learned that the file is compiled using the <code class="language-plaintext highlighter-rouge">.NET</code> framework used by the <code class="language-plaintext highlighter-rouge">C#</code> language; we can decompile the binary code into C# using a decompilation tool like <a href="https://github.com/icsharpcode/ILSpy">ILSpy</a>.</p>

<p>This tool will decompile the code, providing us with readable information we can use to determine the flow of execution. Let’s start by opening ILSpy from the taskbar and then click on <code class="language-plaintext highlighter-rouge">File &gt; Open</code> and then navigate to <code class="language-plaintext highlighter-rouge">C:\Users\Administrator\Desktop\demo</code> and select the file <code class="language-plaintext highlighter-rouge">demo.exe</code>. The tool <code class="language-plaintext highlighter-rouge">ILSpy</code> may take up to 30 seconds to appear on the screen.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/66264cef7bba67a6bbbe7179/room-content/66264cef7bba67a6bbbe7179-1729645613616.png" alt="Opening file in ILSpy" /></p>

<p>As we can observe from above, the left panel contains the libraries used by the framework, and the actual decompiled code is in the section with the file name <strong>demo</strong>. Let’s click on it to expand and see what it contains.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/66264cef7bba67a6bbbe7179/room-content/66264cef7bba67a6bbbe7179-1729797176418.png" alt="checking code in ILSpy" /></p>

<p>As the screenshot above shows, ILSpy can provide much information, like metadata and references. However, the actual show is displayed on the brackets symbols {}, in this case, under <code class="language-plaintext highlighter-rouge">DemoBinary &gt; Program &gt; Main</code>, which is actually the Main function of the executable. Now that we have access to the code running on the binary, let’s analyse it.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">private</span> <span class="kd">static</span> <span class="k">void</span> <span class="nc">Main</span><span class="p">(</span><span class="nx">string</span><span class="p">[]</span> <span class="nx">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="nx">Console</span><span class="p">.</span><span class="nc">WriteLine</span><span class="p">(</span><span class="dl">"</span><span class="s2">Hello THM DEMO Binary</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">Thread</span><span class="p">.</span><span class="nc">Sleep</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
	<span class="nx">string</span> <span class="nx">address</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://10.10.10.10/img/tryhackme_connect.png</span><span class="dl">"</span><span class="p">;</span>
	<span class="nx">string</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">Path</span><span class="p">.</span><span class="nc">Combine</span><span class="p">(</span><span class="nx">Environment</span><span class="p">.</span><span class="nc">GetFolderPath</span><span class="p">(</span><span class="nx">Environment</span><span class="p">.</span><span class="nx">SpecialFolder</span><span class="p">.</span><span class="nx">Desktop</span><span class="p">),</span> <span class="dl">"</span><span class="s2">thm-demo.png</span><span class="dl">"</span><span class="p">);</span>
	<span class="nf">using </span><span class="p">(</span><span class="nx">WebClient</span> <span class="nx">webClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WebClient</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">try</span>
		<span class="p">{</span>
			<span class="nx">Console</span><span class="p">.</span><span class="nc">WriteLine</span><span class="p">(</span><span class="dl">"</span><span class="s2">Downloading file...</span><span class="dl">"</span><span class="p">);</span>
			<span class="nx">webClient</span><span class="p">.</span><span class="nc">DownloadFile</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">text</span><span class="p">);</span>
			<span class="nx">Console</span><span class="p">.</span><span class="nc">WriteLine</span><span class="p">(</span><span class="dl">"</span><span class="s2">File downloaded to: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">text</span><span class="p">);</span>
			<span class="nx">Process</span><span class="p">.</span><span class="nc">Start</span><span class="p">(</span><span class="k">new</span> <span class="nc">ProcessStartInfo</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="nx">UseShellExecute</span> <span class="o">=</span> <span class="kc">true</span>
			<span class="p">});</span>
			<span class="nx">Console</span><span class="p">.</span><span class="nc">WriteLine</span><span class="p">(</span><span class="dl">"</span><span class="s2">Image opened successfully.</span><span class="dl">"</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">catch </span><span class="p">(</span><span class="nx">Exception</span> <span class="nx">ex</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="nx">Console</span><span class="p">.</span><span class="nc">WriteLine</span><span class="p">(</span><span class="dl">"</span><span class="s2">An error occurred: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">ex</span><span class="p">.</span><span class="nx">Message</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">Console</span><span class="p">.</span><span class="nc">WriteLine</span><span class="p">(</span><span class="dl">"</span><span class="s2">Bye Bye leaving Demo Binary</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">Thread</span><span class="p">.</span><span class="nc">Sleep</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The code above displays the main function and its code. We can observe that first, it prints to the screen the message “Hello THM DEMO Binary” using the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.console.writeline?view=net-8.0">Console.Writeline method</a>.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Console</span><span class="p">.</span><span class="nc">WriteLine</span><span class="p">(</span><span class="dl">"</span><span class="s2">Hello THM DEMO Binary</span><span class="dl">"</span><span class="p">);</span>
</code></pre></div></div>

<p>It then uses the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.threading.thread.sleep?view=net-8.0">Sleep</a> method to wait for 5 seconds.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Thread</span><span class="p">.</span><span class="nc">Sleep</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
</code></pre></div></div>

<p>Then, it assigns a value to two string variables: address and text, the first one with a URL accessing a PNG file, and the second one with a file name on the user’s Desktop named <strong>thm-demo.png</strong>.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">string</span> <span class="nx">address</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://10.10.10.10/img/tryhackme_connect.png</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">string</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">Path</span><span class="p">.</span><span class="nc">Combine</span><span class="p">(</span><span class="nx">Environment</span><span class="p">.</span><span class="nc">GetFolderPath</span><span class="p">(</span><span class="nx">Environment</span><span class="p">.</span><span class="nx">SpecialFolder</span><span class="p">.</span><span class="nx">Desktop</span><span class="p">),</span> <span class="dl">"</span><span class="s2">thm-demo.png</span><span class="dl">"</span><span class="p">);</span>
</code></pre></div></div>

<p>Then, it will try to connect to the URL on the <strong>address</strong> variable and save the content to a file on the Desktop using the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.webclient?view=net-8.0">WebClient class</a>, and it will then execute the downloaded file path assigned to the <strong>text</strong> variable using the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.process?view=net-8.0">Process class</a>  and the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.process.start?view=net-8.0#system-diagnostics-process-start(system-string)">Start method</a>, as displayed below.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">using </span><span class="p">(</span><span class="nx">WebClient</span> <span class="nx">webClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WebClient</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">try</span>
		<span class="p">{</span>
			<span class="nx">Console</span><span class="p">.</span><span class="nc">WriteLine</span><span class="p">(</span><span class="dl">"</span><span class="s2">Downloading file...</span><span class="dl">"</span><span class="p">);</span>
			<span class="nx">webClient</span><span class="p">.</span><span class="nc">DownloadFile</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">text</span><span class="p">);</span>
			<span class="nx">Console</span><span class="p">.</span><span class="nc">WriteLine</span><span class="p">(</span><span class="dl">"</span><span class="s2">File downloaded to: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">text</span><span class="p">);</span>
			<span class="nx">Process</span><span class="p">.</span><span class="nc">Start</span><span class="p">(</span><span class="k">new</span> <span class="nc">ProcessStartInfo</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="nx">UseShellExecute</span> <span class="o">=</span> <span class="kc">true</span>
			<span class="p">});</span>
			<span class="nx">Console</span><span class="p">.</span><span class="nc">WriteLine</span><span class="p">(</span><span class="dl">"</span><span class="s2">Image opened successfully.</span><span class="dl">"</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">catch </span><span class="p">(</span><span class="nx">Exception</span> <span class="nx">ex</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="nx">Console</span><span class="p">.</span><span class="nc">WriteLine</span><span class="p">(</span><span class="dl">"</span><span class="s2">An error occurred: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">ex</span><span class="p">.</span><span class="nx">Message</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
</code></pre></div></div>

<p>Finally, it prints the message “<strong>Bye Bye, leaving THM DEMO Binary</strong>” again to the console and waits for 5 seconds using the <strong>Sleep</strong> method before closing.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="nx">Console</span><span class="p">.</span><span class="nc">WriteLine</span><span class="p">(</span><span class="dl">"</span><span class="s2">By bye leaving THM Demo Binary</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">Thread</span><span class="p">.</span><span class="nc">Sleep</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
</code></pre></div></div>

<p>Great! We now understand what the binary is doing. It will download a PNG file to the user’s Desktop from the URL: <code class="language-plaintext highlighter-rouge">http://10.10.10.10/img/tryhackme_connect.png</code>. Let’s execute the file and see if this is true. Once the binary starts, wait for the text “<code class="language-plaintext highlighter-rouge">Hello THM DEMO Binary</code>” to appear, then press <code class="language-plaintext highlighter-rouge">Enter</code> to download the file.</p>

<p><strong>Note</strong>: <em>We are only executing the binary because we are in a sandbox environment; execution of an unknown binary on a host machine is NOT recommended.</em></p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/66264cef7bba67a6bbbe7179/room-content/66264cef7bba67a6bbbe7179-1729799008710.png" alt="Opening file in Paint" /></p>

<p>After executing the file, we can observe that it was downloaded to the Desktop, and the messages print to the screen as expected. Also, the downloaded file is executed and opened using the default app for PNG <strong>Paint</strong>. Excellent, we successfully Reverse-Engineered the flow of the code.</p>

<p>Now that we have some practice, join McSkidy and help investigate the alerts coming from the file <em>WarevilleApp.exe</em>. Put on your reverse engineering hat and help decipher the mystery behind this suspicious binary.</p>

<p><strong>Note</strong>: To answer the question, you will need to reverse the application <code class="language-plaintext highlighter-rouge">WarevilleApp.exe</code>, located at <code class="language-plaintext highlighter-rouge">C:\Users\Administrator\Desktop\</code>.</p>

<h2 id="answer-the-questions-below">Answer the questions below</h2>

<p>What is the function name that downloads and executes files in the WarevilleApp.exe?</p>

<p>DownloadAndExecuteFile</p>

<p>Once you execute the WarevilleApp.exe, it downloads another binary to the Downloads folder. What is the name of the binary?</p>

<p>explorer.exe</p>

<p>What domain name is the one from where the file is downloaded after running WarevilleApp.exe?</p>

<p>mayorc2.thm</p>

<p>The stage 2 binary is executed automatically and creates a zip file comprising the victim’s computer data; what is the name of the zip file?</p>

<p>CollectedFiles.zip</p>

<p>What is the name of the C2 server where the stage 2 binary tries to upload files?</p>

<p>anonymousc2.thm</p>

<p>If you enjoyed this task, feel free to check out the <a href="https://tryhackme.com/r/room/x86assemblycrashcourse">x86 Assembly Crash Course</a> room.</p>

  </article>
  
    <div class="post-share">
  <div class="post-date">Feel free to share!</div>
  <div class="sharing-icons">
    <a href="https://twitter.com/intent/tweet?text=TryHackMe ADvent of Cyber 2024 - Day 21&amp;url=/Day21" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
    <a href="https://www.facebook.com/sharer/sharer.php?u=/Day21&amp;title=TryHackMe ADvent of Cyber 2024 - Day 21" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a>
  </div>
</div>

  
  
    <div class="related">
  <h2>You may also enjoy...</h2>
  
  <ul class="related-posts">
    
  </ul>
</div>

  
  
    <section class="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname = "millennial-3";
    var disqus_identifier = "/Day21";
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

  
</div>

      </div>
      <footer class="footer">
  
    <a href="https://twitter.com/mberger" class="menu-link" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
  
    <a href="feed.xml" class="menu-link" target="_blank"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
  
  <div class="footer-description"><a href="/">THM Advent of Cyber 2024 | a minimalist Jekyll theme for running a blog or publication by Michael</a></div>
</footer>

    </div>
  </body>
</html>
