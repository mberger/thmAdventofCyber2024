<!doctype html>
<html>
  <head>
  <title>
    
      TryHacneMe Advent of Cyber 2023 - Day 20 | THM Advent of Cyber 2024
    
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8">
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/syntax.css">
  <!-- Use Atom -->
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="THM Advent of Cyber 2024" />
  <!-- RSS-v2.0
  <link href="/rss-feed.xml" type="application/rss+xml" rel="alternate" title="THM Advent of Cyber 2024 | a minimalist Jekyll theme for running a blog or publication"/>
  //-->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Source+Code+Pro">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>
  <!-- Google Analytics -->
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'G-MSZW3HWGH8', 'auto');
  ga('send', 'pageview');
</script>

  <!-- Use Jekyll SEO plugin -->
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>TryHacneMe Advent of Cyber 2023 - Day 20 | THM Advent of Cyber 2024</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="TryHacneMe Advent of Cyber 2023 - Day 20" />
<meta name="author" content="Michael" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The Story" />
<meta property="og:description" content="The Story" />
<link rel="canonical" href="http://localhost:4000/Day20" />
<meta property="og:url" content="http://localhost:4000/Day20" />
<meta property="og:site_name" content="THM Advent of Cyber 2024" />
<meta property="og:image" content="http://localhost:4000/Day20Header.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-12-20T00:00:00-05:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/Day20Header.png" />
<meta property="twitter:title" content="TryHacneMe Advent of Cyber 2023 - Day 20" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Michael"},"dateModified":"2024-12-20T00:00:00-05:00","datePublished":"2024-12-20T00:00:00-05:00","description":"The Story","headline":"TryHacneMe Advent of Cyber 2023 - Day 20","image":"http://localhost:4000/Day20Header.png","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/Day20"},"url":"http://localhost:4000/Day20"}</script>
<!-- End Jekyll SEO tag -->

</head>

  <body>
    <div class="container">
      <header class="site-header">
  <h3 class="site-title">
    <a href="/">THM Advent of Cyber 2024</a>
  </h3>
  <nav class="menu-list">
    
      <a href="/about" class="menu-link">About</a>
    
      <a href="/contact" class="menu-link">Contact</a>
    
    
      <a href="https://twitter.com/mberger" class="menu-link" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
    
      <a href="feed.xml" class="menu-link" target="_blank"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
    
  </nav>
  <div class="dropdown">
    <button class="dropbtn"><i class="fa fa-bars" aria-hidden="true"></i></button>
    <div class="dropdown-content">
      
        <a href="/about" class="menu-link">About</a>
      
        <a href="/contact" class="menu-link">Contact</a>
      
      
        <a href="https://twitter.com/mberger" class="menu-link" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
      
        <a href="feed.xml" class="menu-link" target="_blank"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
      
    </div>
  </div>
</header>

      <div class="content-wrapper">
        <div class="post-content">
  <h1>
    TryHacneMe Advent of Cyber 2023 - Day 20
  </h1>
  
    <span class="post-date">
  Written on
  
  December
  20th,
  2024
  by
  
    Michael
  
</span>

  
  
    <div class="featured-image">
      <img src="/assets/img/Day20Header.png">
    </div>
  
  <article>
    <h1 id="the-story">The Story</h1>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/63588b5ef586912c7d03c4f0/room-content/63588b5ef586912c7d03c4f0-1731076103117.png" alt="Task banner for day DAY 20" /></p>

<p><em>Glitch snuck through the shadows, swift as a breeze, \n He captured the traffic with delicate ease. \n A PCAP file from a system gone bad, \n Mayor Malware’s tricks made everything mad!</em></p>

<p>McSkidy sat at her desk, staring at the PCAP file Glitch had just sent over. It was from Marta May Ware’s computer, the latest victim of Mayor Malware’s long-running schemes.</p>

<p>She smiled, glancing at Byte. <em>“Looks like we’d have to use Wireshark again, eh boy?”</em></p>

<p>Glitch’s voice crackled over the comms. <em>“Need any help analyzing it?”</em></p>

<p>McSkidy smiled. “<em>Thanks, Glitch, but I’ve got this.</em>”</p>

<h2 id="learning-objectives">Learning Objectives</h2>

<ul>
  <li>Investigate network traffic using Wireshark</li>
  <li>Identify indicators of compromise (IOCs) in captured network traffic</li>
  <li>Understand how C2 servers operate and communicate with compromised systems</li>
</ul>

<h2 id="connecting-to-the-machine">Connecting to the Machine</h2>

<p>Before moving forward, review the questions in the connection card shown below:</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5f9c7574e201fe31dad228fc/room-content/5f9c7574e201fe31dad228fc-1731578412879.png" alt="Connection card" /> \n</p>

<p>Start the virtual machine by pressing the <code class="language-plaintext highlighter-rouge">Start Machine</code> button below.</p>

<p>Start Machine</p>

<p>The machine will start in split-screen view. If the VM is not visible, use the blue <code class="language-plaintext highlighter-rouge">Show Split View</code> button at the top of the page.</p>

<p>You may also access the VM via RDP using the credentials below:</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/63588b5ef586912c7d03c4f0/room-content/be629720b11a294819516c1d4e738c92.png" alt="THM key" /></p>

<table>
  <thead>
    <tr>
      <th><strong>Username</strong></th>
      <th>Administrator</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Password</strong></td>
      <td>Commandncontrol001</td>
    </tr>
    <tr>
      <td><strong>IP</strong></td>
      <td>MACHINE_IP</td>
    </tr>
  </tbody>
</table>

<h2 id="investigating-the-depths">Investigating the Depths</h2>

<p><em>McSkidy peered at the PCAP with care, \n “What secrets,” she wondered, “are hiding in there?” \n With Wireshark, she’ll dig through each Byte, \n Hoping to shed some much-needed light.</em></p>

<p>Before we dig deeper into Mayor Malware’s intentions, we must learn a few essential things about C2 communication. Whenever a machine is compromised, the command and control server (C2) drops its secret agent (payload) into the target machine. This secret agent is meant to obey the instructions of the C2 server. These instructions include executing malicious commands inside the target, exfiltrating essential files from the system, and much more. Interestingly, after getting into the system, the secret agent, in addition to obeying the instructions sent by the C2, has a way to keep the C2 updated on its current status. It sends a packet to the C2 every few seconds or even minutes to let it know it is active and ready to blast anything inside the target machine that the C2 aims to. These packets are known as beacons.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/63588b5ef586912c7d03c4f0/room-content/63588b5ef586912c7d03c4f0-1729268627590.png" alt="" /></p>

<p>For this room, we will be using Wireshark, an open-source tool that captures and inspects network traffic saved as a PCAP file. It’s a powerful tool, and you’ll encounter it frequently in your journey in cyber security. It is beneficial for understanding the communications between a compromised machine and a C2 server.</p>

<p>If you are unfamiliar with it, here are some key capabilities you’ll see in this room:</p>

<ul>
  <li>Wireshark can analyze traffic and display the information in an easy-to-navigate format regardless of the protocols used (e.g., HTTP, TCP, DNS).</li>
  <li>Wireshark can reconstruct back-and-forth conversations in a network.</li>
  <li>Wireshark allows easy filtering to narrow down essential details.</li>
  <li>Wireshark can also export and analyze objects that are transferred over the network.</li>
</ul>

<p>Of course, Wireshark has more capabilities. If you want to learn more, we suggest you visit our other Wireshark rooms:</p>

<ul>
  <li><a href="https://tryhackme.com/r/room/wiresharkthebasics">Wireshark: The Basics</a> \n</li>
  <li><a href="https://tryhackme.com/r/room/wiresharkpacketoperations">Wireshark: Packet Operations</a> \n</li>
  <li><a href="https://tryhackme.com/r/room/wiresharktrafficanalysis">Wireshark: Traffic Analysis</a> \n</li>
</ul>

<h2 id="diving-deeper">Diving Deeper</h2>

<p>Now that we have a better idea of what C2 traffic looks like and how to use Wireshark, double-click on the file “<em>C2_Traffic_Analysis</em>” on the Desktop. This will automatically open the PCAP file using Wireshark. \n</p>

<p>That’s traffic! Yes, and this would take us to the truth about Mayor Malware.</p>

<p>We already suspect that this machine is compromised. So, let’s narrow down our list so that it will only show traffic coming from the IP address of Marta May Ware’s machine. To do this, click inside the <strong>Display Filter Bar</strong> on the top, type <code class="language-plaintext highlighter-rouge">ip.src == 10.10.229.217</code>, and press <strong>Enter</strong>.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/63588b5ef586912c7d03c4f0/room-content/63588b5ef586912c7d03c4f0-1729246743949.png" alt="Display Filter Bar" /> \n</p>

<p>It’s still a lot, but at least we can now focus our analysis on outbound traffic.</p>

<p>If you scroll down a bit, you will find some interesting packets, specifically those highlighted with an arrow, as shown below.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/63588b5ef586912c7d03c4f0/room-content/63588b5ef586912c7d03c4f0-1729246982740.png" alt="Highlighted packets" /> \n</p>

<p>Initial? Command? Exfiltrate? That is sure to be something!</p>

<p>Let’s dive deeper.</p>

<h2 id="message-received">Message Received</h2>

<p>If you click on the <code class="language-plaintext highlighter-rouge">POST /initial</code> packet (Frame 440), more details will be shown on the bottom panes. These panes will show more detailed information about the packet frame. It shows relevant details such as frame number (440), the destination IP (10.10.123.224), and more.</p>

<p>You can expand each detail if you want, but the critical area to focus on is the lower-right view, the “Packet Bytes” pane.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/63588b5ef586912c7d03c4f0/room-content/63588b5ef586912c7d03c4f0-1729248432169.png" alt="Packet Bytes pane" /> \n</p>

<p>This pane shows the bytes used in the communication in hexadecimal and ASCII character formats. The latter format shows readable text, which can be helpful in investigations.</p>

<p>The screenshot above shows something interesting: “I am in Mayor!”. This piece of text is likely relevant to us.</p>

<p>If we right-click on the <code class="language-plaintext highlighter-rouge">POST /initial</code> packet (Frame 440) and select <code class="language-plaintext highlighter-rouge">Follow</code> &gt; <code class="language-plaintext highlighter-rouge">HTTP Stream</code>, a new pop-up window will appear containing the back-and-forth HTTP communication relevant to the specific session. </p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/63588b5ef586912c7d03c4f0/room-content/63588b5ef586912c7d03c4f0-1730711649896.png" alt="The initial packet" /> \n</p>

<p>This feature is useful when you need to view all requests and responses between the client and the server, as it helps you understand the complete context of the communication.</p>

<p>The text highlighted in red is the message sent from the source to the destination, and blue is the opposite. So, based on the screenshot above, we can see that after the message “I am in Mayor!” was sent, a response that reads “Perfect!” was sent back.</p>

<p><em>Perfect</em>, indeed, Mayor. We got you now!</p>

<p>But let’s not stop here. Other interesting HTTP packets were sent to the same destination IP. If you follow the HTTP Stream for the <code class="language-plaintext highlighter-rouge">GET /command</code> packet (Frame 457), you’ll see a request to the same IP destination. Interestingly, the reply that came back was a command commonly used in Windows and Linux systems to display the current user’s information. This communication suggests that the destination is attempting to gather information about the compromised system, a typical step during an early reconnaissance stage.</p>

<p>Usually, the reply from a C2 server contains the command, instructing the malicious program what to do next. However, the type of instruction depends on the malicious actor’s configuration, intention, and capabilities. These instructions often fall into several categories:</p>

<ol>
  <li><strong>Getting system information:</strong> The attacker may want to know more about the compromised machine to tailor their next moves. This is what we are seeing above.</li>
  <li><strong>Executing commands:</strong> If the attacker needs to perform specific actions, they can also send commands directly. However, this is less stealthy and easily attracts attention.</li>
  <li><strong>Downloading and executing payloads:</strong> The attacker can also send additional payloads to the machine containing additional functionality or tools.</li>
  <li><strong>Exfiltrating data:</strong> This is one of the most common objectives. The program may be instructed to steal valuable data such as sensitive files, credentials, or personal information.</li>
</ol>

<p>Exfiltrate sounds familiar, right?</p>

<h2 id="exfiltrating-the-package">Exfiltrating the Package</h2>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/63588b5ef586912c7d03c4f0/room-content/63588b5ef586912c7d03c4f0-1729268607259.png" alt="Picture of McSkidy" /></p>

<p>If we follow the HTTP Stream for the <code class="language-plaintext highlighter-rouge">POST /exfiltrate</code> packet (Frame 476) sent to the same destination IP, we will see a file exfiltrated to the C2 server. We can also find some clues inside this file. </p>

<p>If you check the rest of the PCAP, you’ll find that more interesting packets were captured. Let’s break these down and dive deeper into what we’ve uncovered.</p>

<h2 id="whats-in-the-beacon">What’s in the Beacon</h2>

<p>A typical C2 beacon returns regular status updates from the compromised machine to its C2 server. The beacons may be sent after regular or irregular intervals to the C2 as a heartbeat. Here’s how this exchange might look:</p>

<ul>
  <li><strong>Secret agent (payload):</strong> “I am still alive. Awaiting any instructions. Over.”</li>
  <li><strong>C2 server:</strong> “Glad to hear that! Stand by for any further instructions. Over.”</li>
</ul>

<p>In this scenario, Mayor Malware’s agent (payload) inside Marta May Ware’s computer has sent a message that is sent inside all the beacons. Since the content is highly confidential, the secret agent encrypts it inside all the beacons, leaving a clue for the Mayor’s C2 to decrypt it. In the current scenario, we can identify the beacons by the multiple requests sent to the C2 from the target machine after regular intervals of time.</p>

<p>The exfiltrated file’s content hints at how these encrypted beacons can be decrypted. Using the encryption algorithm with the provided key, we now have a potential way to unlock the beacon’s message and uncover what Mayor Malware’s agent is communicating to the C2 server.</p>

<p>But what exactly are we about to reveal?</p>

<p>Since the beacon is now encrypted and you have the key to decrypt it, the CyberChef tool would be our source of truth for solving this mystery. Because of its wide features, CyberChef is considered a “Swiss Army Knife”. We can use this tool for encoding, decoding, encrypting, decrypting, hashing, and much more. However, considering this task’s scope, we would only cover the decryption process using this tool.</p>

<p>This <a href="https://gchq.github.io/CyberChef/">link</a> will open the CyberChef tool in your browser. <em>Note that you will have to open this link within your own browser, since the target VM has no internet connection.</em></p>

<p>From the tool’s dashboard, you would be utilizing the following panes for decrypting your beacon:</p>

<ol>
  <li><strong>Operations:</strong> Search for AES Decrypt and drag it to the <strong>Recipe</strong> area, which is in the second pane.</li>
  <li><strong>Recipe:</strong> This is the area where you would select the mode of encryption, ECB, and enter the decryption key you have. Keep the other options as they are.</li>
  <li><strong>Input:</strong> Once the Recipe is done, it is time to enter our encrypted beacon into the <strong>Input</strong> area. Copy your encrypted string and paste it here.</li>
  <li><strong>Output:</strong> Once you have completed the above steps, you need to click the “Bake” button in the Recipe area. Your encrypted string will be decrypted using the AES ECB decryption with the key you provided, and the output will be displayed in the <strong>Output</strong> area.</li>
</ol>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6645aa8c024f7893371eb7ac/room-content/6645aa8c024f7893371eb7ac-1730447407462.png" alt="CyberChef" /></p>

<p>If you want to learn more about CyberChef, check out our <a href="https://tryhackme.com/r/room/cyberchefbasics">CyberChef: The Basics</a> room from the <a href="https://tryhackme.com/r/path/outline/cybersecurity101">Cyber Security 101</a> path.</p>

<h2 id="the-end">The End</h2>

<p><em>As McSkidy opened the file with a click, \n She saw all the data—this wasn’t a wasn’t \n The storm was brewing, much bigger to come, \n Mayor Malware’s agent is far from done!</em></p>

<p><em>“This isn’t just another breach,”</em> McSkidy muttered to Byte, a grim realization dawning. <em>“We’re going to need a bigger firewall.”</em></p>

<h2 id="answer-the-questions-below">Answer the questions below</h2>

<p>What was the first message the payload sent to Mayor Malware’s C2?</p>

<p>I am in Mayor!</p>

<p>What was the IP address of the C2 server?</p>

<p>10.10.123.224</p>

<p>What was the command sent by the C2 server to the target machine?</p>

<p>whoami</p>

<p>What was the filename of the critical file exfiltrated by the C2 server?</p>

<p>credentials.txt</p>

<p>What secret message was sent back to the C2 in an encrypted format through beacons?</p>

<p>THM_Secret_101</p>

<p>Learn more about WireShark in our <a href="https://tryhackme.com/r/room/wiresharktrafficanalysis">Wireshark: Traffic Analysis</a> room.</p>

  </article>
  
    <div class="post-share">
  <div class="post-date">Feel free to share!</div>
  <div class="sharing-icons">
    <a href="https://twitter.com/intent/tweet?text=TryHacneMe Advent of Cyber 2023 - Day 20&amp;url=/Day20" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
    <a href="https://www.facebook.com/sharer/sharer.php?u=/Day20&amp;title=TryHacneMe Advent of Cyber 2023 - Day 20" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a>
  </div>
</div>

  
  
    <div class="related">
  <h2>You may also enjoy...</h2>
  
  <ul class="related-posts">
    
  </ul>
</div>

  
  
    <section class="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname = "millennial-3";
    var disqus_identifier = "/Day20";
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

  
</div>

      </div>
      <footer class="footer">
  
    <a href="https://twitter.com/mberger" class="menu-link" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
  
    <a href="feed.xml" class="menu-link" target="_blank"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
  
  <div class="footer-description"><a href="/">THM Advent of Cyber 2024 | a minimalist Jekyll theme for running a blog or publication by Michael</a></div>
</footer>

    </div>
  </body>
</html>
