<!doctype html>
<html>
  <head>
  <title>
    
      Try Hackme Advent of Cyber - Day 5 | THM Advent of Cyber 2024
    
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8">
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/syntax.css">
  <!-- Use Atom -->
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="THM Advent of Cyber 2024" />
  <!-- RSS-v2.0
  <link href="/rss-feed.xml" type="application/rss+xml" rel="alternate" title="THM Advent of Cyber 2024 | a minimalist Jekyll theme for running a blog or publication"/>
  //-->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Source+Code+Pro">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>
  <!-- Google Analytics -->
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', '', 'auto');
  ga('send', 'pageview');
</script>

  <!-- Use Jekyll SEO plugin -->
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Try Hackme Advent of Cyber - Day 5 | THM Advent of Cyber 2024</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Try Hackme Advent of Cyber - Day 5" />
<meta name="author" content="Paul Le" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Advent of Cyber Day 5" />
<meta property="og:description" content="Advent of Cyber Day 5" />
<link rel="canonical" href="http://localhost:4000/Day5" />
<meta property="og:url" content="http://localhost:4000/Day5" />
<meta property="og:site_name" content="THM Advent of Cyber 2024" />
<meta property="og:image" content="http://localhost:4000/Day5-logo.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-12-05T00:00:00-05:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/Day5-logo.png" />
<meta property="twitter:title" content="Try Hackme Advent of Cyber - Day 5" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Paul Le"},"dateModified":"2024-12-05T00:00:00-05:00","datePublished":"2024-12-05T00:00:00-05:00","description":"Advent of Cyber Day 5","headline":"Try Hackme Advent of Cyber - Day 5","image":"http://localhost:4000/Day5-logo.png","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/Day5"},"url":"http://localhost:4000/Day5"}</script>
<!-- End Jekyll SEO tag -->

</head>

  <body>
    <div class="container">
      <header class="site-header">
  <h3 class="site-title">
    <a href="/">THM Advent of Cyber 2024</a>
  </h3>
  <nav class="menu-list">
    
      <a href="/about" class="menu-link">About</a>
    
      <a href="/contact" class="menu-link">Contact</a>
    
    
      <a href="https://twitter.com/mberger" class="menu-link" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
    
      <a href="feed.xml" class="menu-link" target="_blank"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
    
  </nav>
  <div class="dropdown">
    <button class="dropbtn"><i class="fa fa-bars" aria-hidden="true"></i></button>
    <div class="dropdown-content">
      
        <a href="/about" class="menu-link">About</a>
      
        <a href="/contact" class="menu-link">Contact</a>
      
      
        <a href="https://twitter.com/mberger" class="menu-link" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
      
        <a href="feed.xml" class="menu-link" target="_blank"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
      
    </div>
  </div>
</header>

      <div class="content-wrapper">
        <div class="post-content">
  <h1>
    Try Hackme Advent of Cyber - Day 5
  </h1>
  
    <span class="post-date">
  Written on
  
  December
  5th,
  2024
  by
  
    Paul Le
  
</span>

  
  
    <div class="featured-image">
      <img src="/assets/img/Day5-logo.png">
    </div>
  
  <article>
    <h1 id="advent-of-cyber-day-5">Advent of Cyber Day 5</h1>

<p>The Story</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5dbea226085ab6182a2ee0f7/room-content/5dbea226085ab6182a2ee0f7-1730807266344.png" alt="Task banner for day 5." /></p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5dbea226085ab6182a2ee0f7/room-content/5dbea226085ab6182a2ee0f7-1730283420107.png" alt="Software developing a new application." />The days in Wareville flew by, and Software’s projects were nearly complete, just in time for Christmas. One evening, after wrapping up work, Software was strolling through the town when he came across a young boy looking dejected. Curious, Software asked, “What would you like for Christmas?” The boy replied with a sigh, “I wish for a teddy bear, but I know that my family can’t afford one.”</p>

<p>This brief conversation sparked an idea in Software’s mind—what if there was a platform where everyone in town could share their Christmas wishes, and the Mayor’s office could help make them come true? Excited by the potential, Software introduced the idea to Mayor Malware, who embraced it immediately. The Mayor encouraged the team to build the platform for the people of Wareville.</p>

<p>Through the developers’ dedication and effort, the platform was soon ready and became an instant hit. The townspeople loved it! However, in their rush to meet the holiday deadline, the team had overlooked something critical—thorough security testing. Even Mayor Malware had chipped in to help develop a feature in the final hours. Now, it’s up to you to ensure the application is secure and free of vulnerabilities. Can you guarantee the platform runs safely for the people of Wareville?</p>

<p>Learning Objectives</p>

<ul>
  <li>Understand the basic concepts related to XML  <img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/62a7685ca6e7ce005d3f3afe-1730189972624.png" alt="XML handling data like a file drawer." /></li>
  <li>Explore XML External Entity (XXE) and its components</li>
  <li>Learn how to exploit the vulnerability</li>
  <li>Understand remediation measures</li>
</ul>

<p>Important Concepts</p>

<p><strong>Extensible Markup Language (XML)</strong></p>

<p>XML is a commonly used method to transport and store data in a structured format that humans and machines can easily understand. Consider a scenario where two computers need to communicate and share data. Both devices need to agree on a common format for exchanging information. This agreement (format) is known as <code class="language-plaintext highlighter-rouge">XML</code>. You can think of XML as a digital filing cabinet. Just as a filing cabinet has folders with labelled documents inside, XML uses <code class="language-plaintext highlighter-rouge">tags</code> to label and organise information. These tags are like folders that define the type of data stored. This is what an XML looks like, a simple piece of text information organised in a structured manner:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">people</span><span class="o">&gt;</span>
   <span class="o">&lt;</span><span class="nx">name</span><span class="o">&gt;</span><span class="nx">Glitch</span><span class="o">&lt;</span><span class="sr">/name</span><span class="err">&gt;
</span>   <span class="o">&lt;</span><span class="nx">address</span><span class="o">&gt;</span><span class="nx">Wareville</span><span class="o">&lt;</span><span class="sr">/address</span><span class="err">&gt;
</span>   <span class="o">&lt;</span><span class="nx">email</span><span class="o">&gt;</span><span class="nx">glitch</span><span class="p">@</span><span class="nd">wareville</span><span class="p">.</span><span class="nx">com</span><span class="o">&lt;</span><span class="sr">/email</span><span class="err">&gt;
</span>   <span class="o">&lt;</span><span class="nx">phone</span><span class="o">&gt;</span><span class="mi">111000</span><span class="o">&lt;</span><span class="sr">/phone</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/people</span><span class="err">&gt;
</span></code></pre></div></div>

<p>In this case, the tags **<people>**, **<name>**, **&lt;address&gt;**, etc are like folders in a filing cabinet, but now they store data about Glitch. The content inside the tags, like "`Glitch`," "`Wareville`," and "`123-4567`" represents the actual data being stored. Like before, the key benefit of XML is that it is easily shareable and customisable, allowing you to create your own tags.</name></people></p>

<p><strong>Document Type Definition (DTD)</strong></p>

<p>Now that the two computers have agreed to share data in a common format, what about the structure of the format? Here is when the DTD comes into play. A DTD is a set of <strong>rules</strong> that defines the structure of an XML document. Just like a database scheme, it acts like a blueprint, telling you what elements (tags) and attributes are allowed in the XML file. Think of it as a guideline that ensures the XML document follows a specific structure.</p>

<p>For example, if we want to ensure that an XML document about <code class="language-plaintext highlighter-rouge">people</code> will always include a <code class="language-plaintext highlighter-rouge">name</code>, <code class="language-plaintext highlighter-rouge">address</code>, <code class="language-plaintext highlighter-rouge">email</code>, and <code class="language-plaintext highlighter-rouge">phone number</code>, we would define those rules through a DTD as shown below: \n</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;!</span><span class="nx">DOCTYPE</span> <span class="nx">people</span> <span class="p">[</span>
   <span class="o">&lt;!</span><span class="nx">ELEMENT</span> <span class="nf">people</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">phone</span><span class="p">)</span><span class="o">&gt;</span>
   <span class="o">&lt;!</span><span class="nx">ELEMENT</span> <span class="nf">name </span><span class="p">(</span><span class="nx">#PCDATA</span><span class="p">)</span><span class="o">&gt;</span>
   <span class="o">&lt;!</span><span class="nx">ELEMENT</span> <span class="nf">address </span><span class="p">(</span><span class="nx">#PCDATA</span><span class="p">)</span><span class="o">&gt;</span>
   <span class="o">&lt;!</span><span class="nx">ELEMENT</span> <span class="nf">email </span><span class="p">(</span><span class="nx">#PCDATA</span><span class="p">)</span><span class="o">&gt;</span>
   <span class="o">&lt;!</span><span class="nx">ELEMENT</span> <span class="nf">phone </span><span class="p">(</span><span class="nx">#PCDATA</span><span class="p">)</span><span class="o">&gt;</span>
<span class="p">]</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>In the above DTD, <strong>&lt;!ELEMENT&gt;</strong>  defines the elements (tags) that are allowed, like name, address, email, and phone, whereas <code class="language-plaintext highlighter-rouge">#PCDATA</code> stands for parsed <code class="language-plaintext highlighter-rouge">people</code>data, meaning it will consist of just plain text. \n</p>

<p><strong>Entities</strong></p>

<p>So far, both computers have agreed on the format, the structure of data, and the type of data they will share. Entities in XML are placeholders that allow the insertion of large chunks of data or referencing internal or external files. They assist in making the XML file easy to manage, especially when the same data is repeated multiple times. Entities can be defined internally within the XML document or externally, referencing data from an outside source.</p>

<p>For example, an external entity references data from an external file or resource. In the following code, the entity <code class="language-plaintext highlighter-rouge">&amp;ext;</code> could refer to an external file located at “<code class="language-plaintext highlighter-rouge">http://tryhackme.com/robots.txt</code>”, which would be loaded into the XML, if allowed by the system:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;!</span><span class="nx">DOCTYPE</span> <span class="nx">people</span> <span class="p">[</span>
   <span class="o">&lt;!</span><span class="nx">ENTITY</span> <span class="nx">ext</span> <span class="nx">SYSTEM</span> <span class="dl">"</span><span class="s2">http://tryhackme.com/robots.txt</span><span class="dl">"</span><span class="o">&gt;</span>
<span class="p">]</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">people</span><span class="o">&gt;</span>
   <span class="o">&lt;</span><span class="nx">name</span><span class="o">&gt;</span><span class="nx">Glitch</span><span class="o">&lt;</span><span class="sr">/name</span><span class="err">&gt;
</span>   <span class="o">&lt;</span><span class="nx">address</span><span class="o">&gt;&amp;</span><span class="nx">ext</span><span class="p">;</span><span class="o">&lt;</span><span class="sr">/address</span><span class="err">&gt;
</span>   <span class="o">&lt;</span><span class="nx">email</span><span class="o">&gt;</span><span class="nx">glitch</span><span class="p">@</span><span class="nd">wareville</span><span class="p">.</span><span class="nx">com</span><span class="o">&lt;</span><span class="sr">/email</span><span class="err">&gt;
</span>   <span class="o">&lt;</span><span class="nx">phone</span><span class="o">&gt;</span><span class="mi">111000</span><span class="o">&lt;</span><span class="sr">/phone</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/people</span><span class="err">&gt;
</span></code></pre></div></div>

<p>We are specifically discussing external entities because it is one of the main reasons that XXE is introduced if it is not properly managed.</p>

<p><strong>XML External Entity (XXE)</strong></p>

<p>After understanding XML and how entities work, we can now explore the XXE vulnerability. XXE is an attack that takes advantage of <strong>how XML parsers handle external entities</strong>. When a web application processes an XML file that contains an external entity, the parser attempts to load or execute whatever resource the entity points to. If necessary sanitisation is not in place, the attacker may point the entity to any malicious source/code causing the undesired behaviour of the web app.</p>

<p>For example, if a vulnerable XML parser processes this external entity definition:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;!</span><span class="nx">DOCTYPE</span> <span class="nx">people</span><span class="p">[</span>
   <span class="o">&lt;!</span><span class="nx">ENTITY</span> <span class="nx">thmFile</span> <span class="nx">SYSTEM</span> <span class="dl">"</span><span class="s2">file:///etc/passwd</span><span class="dl">"</span><span class="o">&gt;</span>
<span class="p">]</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">people</span><span class="o">&gt;</span>
   <span class="o">&lt;</span><span class="nx">name</span><span class="o">&gt;</span><span class="nx">Glitch</span><span class="o">&lt;</span><span class="sr">/name</span><span class="err">&gt;
</span>   <span class="o">&lt;</span><span class="nx">address</span><span class="o">&gt;&amp;</span><span class="nx">thmFile</span><span class="p">;</span><span class="o">&lt;</span><span class="sr">/address</span><span class="err">&gt;
</span>   <span class="o">&lt;</span><span class="nx">email</span><span class="o">&gt;</span><span class="nx">glitch</span><span class="p">@</span><span class="nd">wareville</span><span class="p">.</span><span class="nx">com</span><span class="o">&lt;</span><span class="sr">/email</span><span class="err">&gt;
</span>   <span class="o">&lt;</span><span class="nx">phone</span><span class="o">&gt;</span><span class="mi">111000</span><span class="o">&lt;</span><span class="sr">/phone</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/people</span><span class="err">&gt;
</span></code></pre></div></div>

<p>Here, the entity <code class="language-plaintext highlighter-rouge">&amp;thmFile;</code> refers to the sensitive file <code class="language-plaintext highlighter-rouge">/etc/passwd</code>on a system. When the XML is processed, the parser will try to load and display the contents of that file, exposing sensitive information to the attacker. \n</p>

<p>In the upcoming tasks, we will examine how XXE works and how to exploit it.</p>

<p>Connecting to the Machine</p>

<p>Before moving forward, review the questions in the connection card shown below:</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5dbea226085ab6182a2ee0f7/room-content/5dbea226085ab6182a2ee0f7-1731002645527.png" alt="Connetion card, AttackBox and Virtual Machine." /></p>

<p>Click on the green <code class="language-plaintext highlighter-rouge">Start Machine</code> button below to start the virtual machine. While the virtual machine starts, click on the <strong>Start AttackBox</strong> button at the top of the page and browse <strong>Wareville’s WishVille</strong> application at <code class="language-plaintext highlighter-rouge">http://MACHINE_IP</code>. Please wait 1-2 minutes after the system boots completely to let the auto scripts run successfully.</p>

<p>Practical</p>

<ul>
  <li>\</li>
</ul>

<p>Now that you understand the basic concepts related to XML and XXE, we will analyse an application that allows users to view and add products to their carts and perform the checkout activity. You can access the Wareville application hosted on <code class="language-plaintext highlighter-rouge">http://MACHINE_IP</code>. This application allows users to request their Christmas wishes.</p>

<p><strong>Flow of the Application</strong> \n</p>

<p>As a penetration tester, it is important to first analyse the flow of the application. First, the user will browse through the products and add items of interest to their wishlist at <code class="language-plaintext highlighter-rouge">http://MACHINE_IP/product.php</code>. Click on the <code class="language-plaintext highlighter-rouge">Add to Wishlist</code> under <code class="language-plaintext highlighter-rouge">Wareville's Jolly Cap</code>, as shown below:</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5dbea226085ab6182a2ee0f7/room-content/5dbea226085ab6182a2ee0f7-1730813202090.png" alt="Web application's product page." /> \n</p>

<p>After adding products to the wishlist, click the <code class="language-plaintext highlighter-rouge">Cart</code> button or visit <code class="language-plaintext highlighter-rouge">http://MACHINE_IP/cart.php</code> to see the products added to the cart. On the <code class="language-plaintext highlighter-rouge">Cart</code> page, click the <code class="language-plaintext highlighter-rouge">Proceed to Checkout</code> button to buy the items as shown below:</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5dbea226085ab6182a2ee0f7/room-content/5dbea226085ab6182a2ee0f7-1730813300580.png" alt="Web application's cart details." /> \n</p>

<p>On the checkout page, the user will be prompted to enter his name and address as shown below:</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5dbea226085ab6182a2ee0f7/room-content/5dbea226085ab6182a2ee0f7-1730813382277.png" alt="Web application's checkout details." /> \n</p>

<p>Enter any name of your choice and address, and click on <code class="language-plaintext highlighter-rouge">Complete Checkout</code> to place the wish. Once you complete the wish, you will be shown the message <strong>“Wish successful. Your wish has been saved as Wish #21”</strong>, as shown below:</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5dbea226085ab6182a2ee0f7/room-content/5dbea226085ab6182a2ee0f7-1730813503366.png" alt="Wish #21 saved in a new file." /> \n</p>

<p><strong>Wish #21</strong> indicates the wishes placed by a user on the website. Once you click on <strong>Wish #21</strong>, you will see a forbidden page because the details are only accessible to <code class="language-plaintext highlighter-rouge">admins</code>. But can we try to bypass this and access other people’s wishes? This is what we will try to perform in this task.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5dbea226085ab6182a2ee0f7/room-content/5dbea226085ab6182a2ee0f7-1730813503096.png" alt="Error page when accessing the new wish page." /> \n</p>

<p><strong>Intercepting the Request</strong> \n</p>

<p>Before discussing exploiting XXE on the web, let’s learn how to intercept the request. First, we need to configure the environment so that, as a pentester, all web traffic from our browser is routed through Burp Suite. This allows us to see and manipulate the requests as we browse.</p>

<p>We will use Burp Suite, a powerful web vulnerability scanner, to intercept and modify requests for this exploitation. You can access Burp Suite in the <code class="language-plaintext highlighter-rouge">AttackBox</code>. On the desktop of the AttackBox, you will see a Burp Suite icon as shown below:</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/62a7685ca6e7ce005d3f3afe-1728456762740.png" alt="Burp suite icon" /> \n</p>

<p>Once you click the icon, Burp Suite will open with an introductory screen. You will see a message like “<strong>Welcome to Burp Suite</strong>”. Click on the <code class="language-plaintext highlighter-rouge">Next</code> button.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/62a7685ca6e7ce005d3f3afe-1728457165300.png" alt="Burp suite splash screen" /> \n</p>

<p>On the next screen, you will have the option to <code class="language-plaintext highlighter-rouge">Start Burp</code>. Click on the <code class="language-plaintext highlighter-rouge">Start Burp</code> button to start the tool.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/62a7685ca6e7ce005d3f3afe-1728457184817.png" alt="Burp suite startup setting screen" /> \n</p>

<p>Once Burp Suite has started, you will see its main interface with different tabs, such as <code class="language-plaintext highlighter-rouge">Proxy</code>, <code class="language-plaintext highlighter-rouge">Intruder</code>, <code class="language-plaintext highlighter-rouge">Repeater</code> and others.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/62a7685ca6e7ce005d3f3afe-1728630460840.png" alt="Burp suite dashboard with options" /> \n</p>

<p>Inside Burp Suite, click the <code class="language-plaintext highlighter-rouge">Settings</code> tab at the top right. You will see Burp’s browser option available under the <code class="language-plaintext highlighter-rouge">Tools</code> section. Enable <code class="language-plaintext highlighter-rouge">Allow Burp's browser to run without a sandbox option</code> and click on the <strong>close icon</strong> on the top right corner of the <code class="language-plaintext highlighter-rouge">Settings</code> tab as shown below:</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/62a7685ca6e7ce005d3f3afe-1728459438650.png" alt="Enabling Burp browser settings" /> \n</p>

<p>After allowing the browser to run without a sandbox, we would now be able to start the browser with pre-configured Burp Suite’s proxy. Navigate to the <code class="language-plaintext highlighter-rouge">Open browser</code> option located at the <code class="language-plaintext highlighter-rouge">Proxy -&gt; Intercept</code> section of Burp.  Open the browser by clicking the <code class="language-plaintext highlighter-rouge">Open browser</code> as shown below and browse the URL <code class="language-plaintext highlighter-rouge">http://MACHINE_IP</code>, so that all requests are intercepted:</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/62a7685ca6e7ce005d3f3afe-1728625481652.png" alt="opening browser with in Burp suite" /> \n</p>

<p>Once you browse the URL, all the requests are intercepted and can be seen under the <code class="language-plaintext highlighter-rouge">Proxy-&gt;HTTP history</code> tab.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5dbea226085ab6182a2ee0f7/room-content/5dbea226085ab6182a2ee0f7-1730813727577.png" alt="HTTP history tab of Burp." /> \n</p>

<p><strong>What is Happening in the Backend?</strong></p>

<p>Now, when you visit the URL, <code class="language-plaintext highlighter-rouge">http://MACHINE_IP/product.php</code>, and click <code class="language-plaintext highlighter-rouge">Add to Wishlist</code>, an AJAX call is made to <code class="language-plaintext highlighter-rouge">wishlist.php</code> with the following XML as input.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">wishlist</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nx">user_id</span><span class="o">&gt;</span><span class="mi">1</span><span class="o">&lt;</span><span class="sr">/user_id</span><span class="err">&gt;
</span>     <span class="o">&lt;</span><span class="nx">item</span><span class="o">&gt;</span>
       <span class="o">&lt;</span><span class="nx">product_id</span><span class="o">&gt;</span><span class="mi">1</span><span class="o">&lt;</span><span class="sr">/product_id</span><span class="err">&gt;
</span>     <span class="o">&lt;</span><span class="sr">/item</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/wishlist</span><span class="err">&gt;
</span>

</code></pre></div></div>

<p>In the above XML, **<product_id>** tag contains the ID of the product, which is **1** in this case. Now, let's review the `Add to Wishlist` request logged in Burp Suite's `HTTP History` option under the proxy tab. As discussed above, the request contains XML being forwarded as a `POST` request, as shown below:</product_id></p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/62a7685ca6e7ce005d3f3afe-1729006687410.png" alt="View of the request sent to wishlist.php using Burp." /> \n</p>

<p>This <code class="language-plaintext highlighter-rouge">wishlist.php</code> accepts the request and parses the request using the following code:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">&lt;</span><span class="p">?</span><span class="nx">php</span>
<span class="p">..</span>
<span class="p">...</span>
<span class="nf">libxml_disable_entity_loader</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="nx">$wishlist</span> <span class="o">=</span> <span class="nf">simplexml_load_string</span><span class="p">(</span><span class="nx">$xml_data</span><span class="p">,</span> <span class="dl">"</span><span class="s2">SimpleXMLElement</span><span class="dl">"</span><span class="p">,</span> <span class="nx">LIBXML_NOENT</span><span class="p">);</span>

<span class="p">...</span>
<span class="p">..</span>
<span class="nx">echo</span> <span class="dl">"</span><span class="s2">Item added to your wishlist successfully.</span><span class="dl">"</span><span class="p">;</span>
<span class="p">?</span><span class="o">&gt;</span>


</code></pre></div></div>

<p><strong>Preparing the Payload</strong></p>

<p>When a user sends specially crafted XML data to the application, the line <code class="language-plaintext highlighter-rouge">libxml_disable_entity_loader(false)</code> allows the XML parser to load external entities. This means the XML input can include external file references or requests to remote servers. When the XML is processed by <code class="language-plaintext highlighter-rouge">simplexml_load_string</code> with the <code class="language-plaintext highlighter-rouge">LIBXML_NOENT</code>option, the web app resolves external entities, allowing attackers access to sensitive files or allowing them to make unintended requests from the server. \n</p>

<p>What if we update the XML request to include references for external entities? We will use the following XML instead of the above XML:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c">&lt;!--</span><span class="p">?</span><span class="nx">xml</span> <span class="nx">version</span><span class="o">=</span><span class="dl">"</span><span class="s2">1.0</span><span class="dl">"</span> <span class="p">?</span><span class="o">--&gt;</span>
<span class="o">&lt;!</span><span class="nx">DOCTYPE</span> <span class="nx">foo</span> <span class="p">[</span><span class="o">&lt;!</span><span class="nx">ENTITY</span> <span class="nx">payload</span> <span class="nx">SYSTEM</span> <span class="dl">"</span><span class="s2">/etc/hosts</span><span class="dl">"</span><span class="o">&gt;</span> <span class="p">]</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">wishlist</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nx">user_id</span><span class="o">&gt;</span><span class="mi">1</span><span class="o">&lt;</span><span class="sr">/user_id</span><span class="err">&gt;
</span>     <span class="o">&lt;</span><span class="nx">item</span><span class="o">&gt;</span>
       <span class="o">&lt;</span><span class="nx">product_id</span><span class="o">&gt;&amp;</span><span class="nx">payload</span><span class="p">;</span><span class="o">&lt;</span><span class="sr">/product_id</span><span class="err">&gt;
</span>     <span class="o">&lt;</span><span class="sr">/item</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/wishlist</span><span class="err">&gt;
</span>

</code></pre></div></div>

<p>When we send this updated XML payload, the first two lines introduce an external entity called <strong>payload</strong>. The line &lt;<strong>!ENTITY payload SYSTEM “/etc/hosts”&gt;</strong> tells the XML parser to replace the <strong>&amp;payload;</strong> reference with the contents of the file <strong>/etc/hosts</strong> on the server. When the XML is processed, instead of a normal <strong>product_id</strong>, the application will try to load and include the contents of the file specified in the entity (<code class="language-plaintext highlighter-rouge">/etc/hosts</code>).</p>

<p><strong>Exploitation</strong></p>

<p>Now, let’s perform the exploitation by repeating the request we captured earlier. The Burp Suite tool has a feature known as <code class="language-plaintext highlighter-rouge">Repeater</code> that allows you to send multiple HTTP requests. We will use this feature to duplicate our <code class="language-plaintext highlighter-rouge">HTTP POST</code> request and send it multiple times to exploit the vulnerability. Right-click on the <code class="language-plaintext highlighter-rouge">wishlist.php</code> POST request and click on <code class="language-plaintext highlighter-rouge">Send to Repeater</code>. \n</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/62a7685ca6e7ce005d3f3afe-1729012048433.png" alt="Instructions to send a request to the Repeater tab." />** \n **</p>

<p>Now, switch to the <code class="language-plaintext highlighter-rouge">Repeater</code> tab, where you’ll find the <code class="language-plaintext highlighter-rouge">POST</code> request that needs to be modified. We will update the XML payload with the new data as shown below and then send the modified request:</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/62a7685ca6e7ce005d3f3afe-1729018934528.png" alt="Updated the XML with an XXE payload." /> \n</p>

<p>Place the mouse cursor inside the request in the <code class="language-plaintext highlighter-rouge">Repeater</code> tab in Burp Suite and press <code class="language-plaintext highlighter-rouge">Ctrl+V</code>  or paste the payload in the above-highlighted area.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/62a7685ca6e7ce005d3f3afe-1729019108929.png" alt="Initial XXE payload and its response." /> \n</p>

<p>When we clicked <code class="language-plaintext highlighter-rouge">Send</code>, the server processed the malicious XML payload, which included the external entity reference to <code class="language-plaintext highlighter-rouge">/etc/hosts</code>. As a result, the <code class="language-plaintext highlighter-rouge">wishlist.php</code> responded with the contents of the <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file, leading to an XXE vulnerability.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5dbea226085ab6182a2ee0f7/room-content/5dbea226085ab6182a2ee0f7-1730283613622.png" alt="Software playing with the web." />Time for Some Action</p>

<p>Now that you’ve identified a vulnerability in the application, it’s time to see it in action! McSkidy Software has tasked us with finding loopholes, and we’ve successfully uncovered one in the <code class="language-plaintext highlighter-rouge">wishlist.php</code> endpoint. But our work doesn’t end there—let’s take it a step further and assess the potential impact this vulnerability could have on the application.</p>

<p>Earlier, we discovered a page accessible only by administrators, which seems like an exciting target. What if we could use the vulnerability we’ve found to access sensitive information, like the wishes placed by the townspeople?</p>

<p>Now that our objective is clear, let’s leverage the vulnerability we discovered to read the contents of each wishes page and demonstrate the full extent of this flaw to help McSkidy secure the platform. To get started, let’s recall the page that is only accessible by admins - <code class="language-plaintext highlighter-rouge">/wishes/wish_1.txt</code>. Using this path, we just need to guess the potential absolute path of the file. Typically, web applications are hosted on <code class="language-plaintext highlighter-rouge">/var/www/html</code>. With that in mind, let’s build our new payload to read the wishes while leveraging the vulnerability.</p>

<p><strong>Note: Not all web applications use the path /var/www/html, but web servers typically use it.</strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c">&lt;!--</span><span class="p">?</span><span class="nx">xml</span> <span class="nx">version</span><span class="o">=</span><span class="dl">"</span><span class="s2">1.0</span><span class="dl">"</span> <span class="p">?</span><span class="o">--&gt;</span>
<span class="o">&lt;!</span><span class="nx">DOCTYPE</span> <span class="nx">foo</span> <span class="p">[</span><span class="o">&lt;!</span><span class="nx">ENTITY</span> <span class="nx">payload</span> <span class="nx">SYSTEM</span> <span class="dl">"</span><span class="s2">/var/www/html/wishes/wish_1.txt</span><span class="dl">"</span><span class="o">&gt;</span> <span class="p">]</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">wishlist</span><span class="o">&gt;</span>
	<span class="o">&lt;</span><span class="nx">user_id</span><span class="o">&gt;</span><span class="mi">1</span><span class="o">&lt;</span><span class="sr">/user_id</span><span class="err">&gt;
</span>	<span class="o">&lt;</span><span class="nx">item</span><span class="o">&gt;</span>
	       <span class="o">&lt;</span><span class="nx">product_id</span><span class="o">&gt;&amp;</span><span class="nx">payload</span><span class="p">;</span><span class="o">&lt;</span><span class="sr">/product_id</span><span class="err">&gt;
</span>	<span class="o">&lt;</span><span class="sr">/item</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/wishlist</span><span class="err">&gt;
</span>


</code></pre></div></div>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5dbea226085ab6182a2ee0f7/room-content/5dbea226085ab6182a2ee0f7-1730814018118.png" alt="Leaking the wishes via XXE." /> \n</p>

<p>Surprisingly, we got lucky that our assumption worked. The next thing to do is see whether we can view more wishes using our discovery. To do this, let’s try replacing the <code class="language-plaintext highlighter-rouge">wish_1.txt</code> with <code class="language-plaintext highlighter-rouge">wish_2.txt</code>.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5dbea226085ab6182a2ee0f7/room-content/5dbea226085ab6182a2ee0f7-1730814073518.png" alt="Iterating within the wishes via XXE." /> \n</p>

<p>As a result, we were able to view the next wish. You may observe that we just incremented the number by one. Given this, you may continue checking the other wishes and see all the wishes stored in the application.</p>

<p>After iterating through the wishes, we have proved the potential impact of the vulnerability, and anyone who leverages this could read the wishes submitted by the townspeople of Wareville.</p>

<p>Conclusion</p>

<p>It was confirmed that the application was vulnerable, and the developers were not at fault since they only wanted to give the townspeople something before Christmas. However, it became evident that bypassing security testing led to an application that did not securely handle incoming requests.</p>

<p>As soon as the vulnerability was discovered, McSkidy promptly coordinated with the developers to implement the necessary mitigations. The following proactive approach helped to address the potential risks against XXE attacks:</p>

<ul>
  <li><strong>Disable External Entity Loading</strong>: The primary fix is to disable external entity loading in your XML parser. In PHP, for example, you can prevent XXE by setting <code class="language-plaintext highlighter-rouge">libxml_disable_entity_loader(true)</code> before processing the XML.</li>
  <li><strong>Validate and Sanitise User Input</strong>: Always validate and sanitise the XML input received from users. This ensures that only expected data is processed, reducing the risk of malicious content being included in the request. For example, remove suspicious keywords like <code class="language-plaintext highlighter-rouge">/etc/host</code>, <code class="language-plaintext highlighter-rouge">/etc/passwd</code>, etc, from the request.</li>
</ul>

<p>After discovering the vulnerability, McSkidy immediately remembered that a CHANGELOG file exists within the web application, stored at the following endpoint: <a href="http://MACHINE_IP/CHANGELOG">http://MACHINE_IP/CHANGELOG</a>. After checking, it can be seen that someone pushed the vulnerable code within the application after Software’s team.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5dbea226085ab6182a2ee0f7/room-content/5dbea226085ab6182a2ee0f7-1729260978473.png" alt="CHANGELOG data." /> \n</p>

<p>With this discovery, McSkidy still couldn’t confirm whether the Mayor intentionally made the application vulnerable. However, the Mayor had already become suspicious, and McSkidy began to formulate theories about his possible involvement.</p>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5dbea226085ab6182a2ee0f7/room-content/5dbea226085ab6182a2ee0f7-1730283636344.png" alt="Mayor Malware's schemes." /></p>

<p>Answer the questions below</p>

<p>What is the flag discovered after navigating through the wishes?</p>

<p>THM{Brut3f0rc1n6_mY_w4y}</p>

<p>What is the flag seen on the possible proof of sabotage?</p>

<p>THM{m4y0r_m4lw4r3_b4ckd00rs}</p>

<p>If you want to learn more about the XXE injection attack, check out the <a href="https://tryhackme.com/r/room/xxeinjection">XXE </a>room!</p>

<p>Following McSkidy’s advice, Software recently hardened the server.</p>

<p>It used to have many unneeded open ports, but not anymore. Not that this matters in any way.</p>


  </article>
  
    <div class="post-share">
  <div class="post-date">Feel free to share!</div>
  <div class="sharing-icons">
    <a href="https://twitter.com/intent/tweet?text=Try Hackme Advent of Cyber - Day 5&amp;url=/Day5" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
    <a href="https://www.facebook.com/sharer/sharer.php?u=/Day5&amp;title=Try Hackme Advent of Cyber - Day 5" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a>
  </div>
</div>

  
  
    <div class="related">
  <h2>You may also enjoy...</h2>
  
  <ul class="related-posts">
    
      
        
          <li>
            <h3>
              <a href="/Day8">
                <div class="related-thumbnail">
                  
                    <img src="http://localhost:4000/assets/img/Day8-logo.png">
                  
                </div>
                <div class="related-title">
                  Day8
                </div>
                <!--<small>December 8, 2024</small>-->
              </a>
            </h3>
          </li>
          
        
      
        
          <li>
            <h3>
              <a href="/Day7">
                <div class="related-thumbnail">
                  
                    <img src="http://localhost:4000/assets/img/Day7-logo.png">
                  
                </div>
                <div class="related-title">
                  Try Hackme Advent of Cyber - Day 7
                </div>
                <!--<small>December 7, 2024</small>-->
              </a>
            </h3>
          </li>
          
        
      
    
      
        
        
      
        
        
      
    
  </ul>
</div>

  
  
    <section class="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname = "millennial-3";
    var disqus_identifier = "/Day5";
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

  
</div>

      </div>
      <footer class="footer">
  
    <a href="https://twitter.com/mberger" class="menu-link" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
  
    <a href="feed.xml" class="menu-link" target="_blank"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
  
  <div class="footer-description"><a href="/">THM Advent of Cyber 2024 | a minimalist Jekyll theme for running a blog or publication by Michael</a></div>
</footer>

    </div>
  </body>
</html>
